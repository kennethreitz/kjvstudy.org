{% extends "base.html" %}

{% block title %}Biblical Maps - KJV Study{% endblock %}

{% block description %}Explore the geographical context of Scripture with interactive biblical maps showing locations, journeys, and historical events from both the Old and New Testaments.{% endblock %}

{% block keywords %}biblical maps, Bible geography, biblical locations, Jerusalem, Holy Land, Paul's journeys, Old Testament maps, New Testament maps{% endblock %}

{% block extra_head %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        .maps-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .maps-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .maps-header h1 {
            color: var(--primary-light);
            margin-bottom: 10px;
            font-family: var(--font-display);
        }
        
        .maps-header p {
            color: var(--text-secondary);
            font-size: 16px;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .map-controls {
            background: var(--surface-color);
            padding: 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        .control-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-light);
            font-family: var(--font-display);
        }
        
        .search-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .search-input {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: var(--font-serif);
            min-width: 200px;
            flex: 1;
            background: var(--background-color);
            color: var(--text-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(75, 46, 131, 0.2);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .search-btn, .book-btn {
            padding: 10px 16px;
            background: var(--primary-color);
            color: var(--text-primary);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-family: var(--font-serif);
            transition: background-color 0.3s;
        }
        
        .search-btn:hover, .book-btn:hover {
            background: var(--primary-light);
        }
        
        .book-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .book-btn {
            padding: 6px 12px;
            font-size: 14px;
            background: var(--border-color);
            color: var(--text-secondary);
        }
        
        .book-btn.active {
            background: var(--primary-color);
            color: var(--text-primary);
        }
        
        .book-btn.clear-filter {
            background: var(--text-muted);
            color: var(--background-color);
        }
        
        .book-btn.clear-filter:hover {
            background: var(--text-secondary);
        }
        
        .period-filter {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .period-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .period-checkbox input[type="checkbox"] {
            margin: 0;
            accent-color: var(--primary-color);
        }
        
        .period-checkbox label {
            font-weight: normal !important;
            color: var(--text-secondary) !important;
            margin-bottom: 0 !important;
            cursor: pointer;
        }
        
        #biblical-map {
            height: 600px;
            width: 100%;
            border: 2px solid var(--primary-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            position: relative;
            z-index: 1;
        }
        
        .map-legend {
            background: var(--surface-color);
            padding: 15px;
            border-radius: var(--radius-lg);
            margin-top: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        
        .map-legend h3 {
            margin: 0 0 10px 0;
            color: var(--primary-light);
            font-family: var(--font-display);
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }
        
        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            font-size: 10px;
        }
        
        .error-message {
            background: rgba(220, 53, 69, 0.1);
            color: #ff6b6b;
            padding: 12px;
            border-radius: var(--radius-md);
            margin: 10px 0;
            border: 1px solid rgba(220, 53, 69, 0.3);
            display: none;
        }
        
        .info-panel {
            background: rgba(75, 46, 131, 0.1);
            border: 1px solid var(--primary-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }
        
        .info-panel h3 {
            color: var(--primary-light);
            margin: 0 0 10px 0;
            font-family: var(--font-display);
        }
        
        .info-panel p {
            margin: 0;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        
        /* Dark theme for Leaflet map controls */
        .leaflet-control-layers {
            background: var(--surface-color) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        .leaflet-control-layers-list {
            color: var(--text-primary) !important;
        }
        
        .leaflet-control-layers-separator {
            border-top: 1px solid var(--border-color) !important;
        }
        
        .leaflet-popup-content-wrapper {
            background: var(--surface-color) !important;
            color: var(--text-primary) !important;
            border-radius: var(--radius-md) !important;
        }
        
        .leaflet-popup-tip {
            background: var(--surface-color) !important;
        }
        
        .biblical-location-info h3 {
            margin: 0 0 8px 0;
            color: var(--primary-light) !important;
            font-size: 16px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 4px;
        }
        
        .biblical-location-info .description {
            margin: 8px 0;
            font-size: 14px;
            color: var(--text-secondary) !important;
        }
        
        .biblical-location-info .verses {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-muted) !important;
        }
        
        .biblical-location-info .verse-link {
            color: var(--primary-light) !important;
            text-decoration: none;
            font-weight: 500;
        }
        
        .biblical-location-info .verse-link:hover {
            text-decoration: underline;
            color: var(--accent-color) !important;
        }
        
        @media (max-width: 768px) {
            .maps-container {
                padding: 10px;
            }
            
            #biblical-map {
                height: 400px;
                width: 100%;
            }
            
            .search-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input {
                min-width: unset;
            }
            
            .book-selector {
                justify-content: center;
            }
            
            .legend-items {
                grid-template-columns: 1fr;
            }
            
            .period-filter {
                justify-content: center;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="maps-container">
    <div class="maps-header">
        <h1>üó∫Ô∏è Biblical Maps</h1>
        <p>Explore the geographical context of Scripture with interactive maps showing biblical locations, journeys, and historical events from both the Old and New Testaments.</p>
    </div>

    <div class="info-panel">
        <h3>üìç How to Use Biblical Maps</h3>
        <p>Click on map markers to learn about biblical locations and their significance. Use the layer controls to show different time periods, search for specific places, or filter by Bible books. Each location includes relevant Scripture references you can click to explore further.</p>
    </div>

    <div class="map-controls">
        <div class="control-group">
            <label for="location-search">üîç Search Biblical Locations</label>
            <div class="search-container">
                <input type="text" 
                       id="location-search" 
                       class="search-input" 
                       placeholder="Search for Jerusalem, Bethlehem, Damascus..."
                       autocomplete="off">
                <button type="button" id="search-location-btn" class="search-btn">
                    Search
                </button>
                <button type="button" id="clear-search-btn" class="search-btn" style="background: var(--border-color); color: var(--text-secondary);">
                    Clear
                </button>
            </div>
            <div id="search-error" class="error-message">
                Location not found. Try searching for Jerusalem, Bethlehem, Damascus, or other biblical cities.
            </div>
        </div>

        <div class="control-group">
            <label>üìö Filter by Bible Book</label>
            <div class="book-selector">
                <button type="button" class="book-btn" data-book="Genesis">Genesis</button>
                <button type="button" class="book-btn" data-book="Exodus">Exodus</button>
                <button type="button" class="book-btn" data-book="Joshua">Joshua</button>
                <button type="button" class="book-btn" data-book="1 Samuel">1 Samuel</button>
                <button type="button" class="book-btn" data-book="2 Samuel">2 Samuel</button>
                <button type="button" class="book-btn" data-book="1 Kings">1 Kings</button>
                <button type="button" class="book-btn" data-book="Matthew">Matthew</button>
                <button type="button" class="book-btn" data-book="Mark">Mark</button>
                <button type="button" class="book-btn" data-book="Luke">Luke</button>
                <button type="button" class="book-btn" data-book="John">John</button>
                <button type="button" class="book-btn" data-book="Acts">Acts</button>
                <button type="button" class="book-btn" data-book="Romans">Romans</button>
                <button type="button" class="book-btn clear-filter">Clear Filter</button>
            </div>
        </div>

        <div class="control-group">
            <label>‚è∞ Time Periods</label>
            <div class="period-filter">
                <div class="period-checkbox">
                    <input type="checkbox" id="show-ot" checked>
                    <label for="show-ot">Old Testament</label>
                </div>
                <div class="period-checkbox">
                    <input type="checkbox" id="show-nt" checked>
                    <label for="show-nt">New Testament</label>
                </div>
                <div class="period-checkbox">
                    <input type="checkbox" id="show-journeys" checked>
                    <label for="show-journeys">Paul's Journeys</label>
                </div>
            </div>
        </div>
    </div>

    <div id="biblical-map"></div>

    <div class="map-legend">
        <h3>üó∫Ô∏è Map Legend</h3>
        <div class="legend-items">
            <div class="legend-item">
                <div class="legend-icon" style="background-color: #8B4513;">üèõÔ∏è</div>
                <span>Biblical Cities</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background-color: #8B7355;">‚õ∞Ô∏è</div>
                <span>Mountains & High Places</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background-color: #4682B4;">üåä</div>
                <span>Bodies of Water</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background-color: #DAA520;">üïå</div>
                <span>Temples & Holy Sites</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background-color: #DC143C;">‚ú®</div>
                <span>Major Biblical Events</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Biblical Maps JavaScript -->
    <script src="{{ url_for('static', path='/js/biblical-maps.js') }}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for CSS to load, then initialize the biblical maps
            setTimeout(function() {
                console.log('Initializing biblical maps...');
                const mapContainer = document.getElementById('biblical-map');
                console.log('Map container:', mapContainer);
                
                if (!mapContainer) {
                    console.error('Map container not found!');
                    return;
                }
                
                try {
                    const biblicalMaps = new BiblicalMaps();
                    const map = biblicalMaps.init('biblical-map');
                    console.log('Map initialized:', map);
                } catch (error) {
                    console.error('Error initializing map:', error);
                }
            }, 100);
            
            // Search functionality
            const searchInput = document.getElementById('location-search');
            const searchBtn = document.getElementById('search-location-btn');
            const clearBtn = document.getElementById('clear-search-btn');
            const errorMsg = document.getElementById('search-error');
            
            function performSearch() {
                const query = searchInput.value.trim();
                if (query) {
                    const found = biblicalMaps.searchLocation(query);
                    if (!found) {
                        errorMsg.style.display = 'block';
                        setTimeout(() => {
                            errorMsg.style.display = 'none';
                        }, 3000);
                    } else {
                        errorMsg.style.display = 'none';
                    }
                }
            }
            
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                errorMsg.style.display = 'none';
                // Reset map to default view
                biblicalMaps.map.setView([31.7683, 35.2137], 7);
            });
            
            // Book filter functionality
            const bookButtons = document.querySelectorAll('.book-btn');
            bookButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const book = this.dataset.book;
                    
                    if (this.classList.contains('clear-filter')) {
                        // Clear all filters
                        bookButtons.forEach(btn => btn.classList.remove('active'));
                        biblicalMaps.clearHighlights();
                        return;
                    }
                    
                    // Toggle active state
                    bookButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show locations for this book
                    biblicalMaps.showBookLocations(book);
                });
            });
            
            // Period filter functionality
            const otCheckbox = document.getElementById('show-ot');
            const ntCheckbox = document.getElementById('show-nt');
            const journeysCheckbox = document.getElementById('show-journeys');
            
            function updateLayerVisibility() {
                const map = biblicalMaps.map;
                
                // Old Testament layers
                if (otCheckbox.checked) {
                    if (!map.hasLayer(biblicalMaps.mapLayers['Old Testament Cities'])) {
                        map.addLayer(biblicalMaps.mapLayers['Old Testament Cities']);
                    }
                } else {
                    if (map.hasLayer(biblicalMaps.mapLayers['Old Testament Cities'])) {
                        map.removeLayer(biblicalMaps.mapLayers['Old Testament Cities']);
                    }
                }
                
                // New Testament layers
                if (ntCheckbox.checked) {
                    if (!map.hasLayer(biblicalMaps.mapLayers['New Testament Cities'])) {
                        map.addLayer(biblicalMaps.mapLayers['New Testament Cities']);
                    }
                } else {
                    if (map.hasLayer(biblicalMaps.mapLayers['New Testament Cities'])) {
                        map.removeLayer(biblicalMaps.mapLayers['New Testament Cities']);
                    }
                }
                
                // Paul's Journeys layers
                if (journeysCheckbox.checked) {
                    if (!map.hasLayer(biblicalMaps.mapLayers["Paul's Journeys"])) {
                        map.addLayer(biblicalMaps.mapLayers["Paul's Journeys"]);
                    }
                } else {
                    if (map.hasLayer(biblicalMaps.mapLayers["Paul's Journeys"])) {
                        map.removeLayer(biblicalMaps.mapLayers["Paul's Journeys"]);
                    }
                }
                
                // Always show major events and tribal territories
                if (!map.hasLayer(biblicalMaps.mapLayers['Major Events'])) {
                    map.addLayer(biblicalMaps.mapLayers['Major Events']);
                }
                if (!map.hasLayer(biblicalMaps.mapLayers['Tribal Territories'])) {
                    map.addLayer(biblicalMaps.mapLayers['Tribal Territories']);
                }
            }
            
            otCheckbox.addEventListener('change', updateLayerVisibility);
            ntCheckbox.addEventListener('change', updateLayerVisibility);
            journeysCheckbox.addEventListener('change', updateLayerVisibility);
            
            // Auto-complete suggestions for search
            const biblicalLocationNames = [
                'Jerusalem', 'Bethlehem', 'Nazareth', 'Capernaum', 'Jericho',
                'Damascus', 'Babylon', 'Memphis', 'Mount Sinai', 'Mount Carmel',
                'Antioch', 'Athens', 'Corinth', 'Ephesus', 'Rome',
                'Sea of Galilee', 'Dead Sea', 'Jordan River'
            ];
            
            searchInput.addEventListener('input', function() {
                // Simple auto-complete logic could be added here
                const value = this.value.toLowerCase();
                // For now, just hide error when user starts typing
                errorMsg.style.display = 'none';
            });
            
            // Responsive map resize
            window.addEventListener('resize', function() {
                biblicalMaps.resize();
            });
        });
    </script>
{% endblock %}