{% extends "base.html" %} 
{% block title %}Biblical Family Tree Explorer - KJV Study{% endblock %} 
{% block description %}Explore biblical genealogies with an interactive person index and family tree viewer. Browse from Adam to the patriarchs with detailed family relationships.{% endblock %} 
{% block keywords %}biblical family tree, biblical genealogy, Adam and Eve, patriarchs, biblical lineage, Old Testament families, KJV genealogy{% endblock %} 
{% block og_title %}Biblical Family Tree Explorer - KJV Study{% endblock %} 

{% block head %}
<style>
    .family-explorer-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
    }

    .family-explorer-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem 1rem;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 12px;
        color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .family-explorer-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        font-family: "Crimson Text", serif;
    }

    .family-explorer-header p {
        font-size: 1.1rem;
        opacity: 0.9;
        max-width: 700px;
        margin: 0 auto;
    }

    .explorer-layout {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    .person-index {
        background: var(--card-background);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        height: fit-content;
        max-height: 80vh;
        overflow-y: auto;
    }

    .index-header {
        margin-bottom: 1.5rem;
    }

    .index-header h2 {
        color: var(--primary-color);
        font-family: "Crimson Text", serif;
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }

    .search-box {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
        background: var(--background-color);
        color: var(--text-color);
        margin-bottom: 1rem;
    }

    .search-box:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(75, 46, 131, 0.1);
    }

    .filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .filter-btn {
        padding: 0.4rem 0.8rem;
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.2s ease;
    }

    .filter-btn:hover,
    .filter-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .person-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .person-item {
        padding: 0.75rem;
        cursor: pointer;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .person-item:hover {
        background: var(--hover-background);
        border-color: var(--border-color);
    }

    .person-item.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .person-name {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }

    .person-title {
        font-size: 0.8rem;
        opacity: 0.8;
        margin-bottom: 0.25rem;
    }

    .person-generation {
        font-size: 0.7rem;
        opacity: 0.6;
    }

    .family-viewer {
        background: var(--card-background);
        border-radius: 12px;
        padding: 2rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        min-height: 80vh;
    }

    .view-toggle {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        gap: 0.5rem;
    }

    .view-btn {
        padding: 0.5rem 1rem;
        border: 2px solid var(--primary-color);
        background: transparent;
        color: var(--primary-color);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .view-btn.active {
        background: var(--primary-color);
        color: white;
    }

    .view-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    .tree-view {
        display: none;
        margin-top: 2rem;
    }

    .tree-view.active {
        display: block;
    }

    .nuclear-family-container {
        position: relative;
        width: 100%;
        height: 500px;
        background: var(--background-color);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .nuclear-family-network {
        position: relative;
        width: 100%;
        height: 100%;
        padding: 2rem;
    }

    .family-member {
        position: absolute;
        background: white;
        border: 3px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
        min-width: 100px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .family-member:hover {
        border-color: var(--primary-color);
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        z-index: 10;
    }

    .family-member.current {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(var(--primary-color-rgb), 0.3);
    }

    .family-member.spouse {
        background: #e8f5e8;
        border-color: #28a745;
    }

    .family-member.parent {
        background: #fff3cd;
        border-color: #ffc107;
    }

    .family-member.child {
        background: #f8d7da;
        border-color: #dc3545;
    }

    .family-member .name {
        font-weight: 600;
        margin-bottom: 0.25rem;
        font-size: 0.85rem;
        line-height: 1.2;
    }

    .family-member .role {
        font-size: 0.7rem;
        opacity: 0.8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .connection-line {
        position: absolute;
        background: var(--border-color);
        z-index: 1;
    }

    .connection-line.marriage {
        background: #28a745;
        height: 3px;
    }

    .connection-line.parent-child {
        background: #007bff;
        width: 3px;
    }

    .connection-line.sibling {
        background: #6c757d;
        height: 2px;
    }

    .family-legend {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        font-size: 0.8rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        border: 1px solid #ccc;
    }

    @media (max-width: 768px) {
        .nuclear-family-container {
            height: 350px;
        }

        .family-member {
            min-width: 70px;
            padding: 0.5rem;
        }

        .family-member .name {
            font-size: 0.7rem;
        }

        .family-member .role {
            font-size: 0.55rem;
        }

        .family-legend {
            font-size: 0.65rem;
            padding: 0.5rem;
            top: 0.5rem;
            right: 0.5rem;
        }

        .legend-item {
            margin-bottom: 0.25rem;
        }

        .legend-color {
            width: 10px;
            height: 10px;
        }
    }

    .welcome-message {
        text-align: center;
        color: var(--text-muted);
        padding: 4rem 2rem;
    }

    .welcome-message h3 {
        color: var(--primary-color);
        font-family: "Crimson Text", serif;
        margin-bottom: 1rem;
    }

    .current-person {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: var(--background-color);
        border-radius: 8px;
        border: 2px solid var(--primary-color);
    }

    .current-person h2 {
        font-size: 2rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        font-family: "Crimson Text", serif;
    }

    .current-person .title {
        font-size: 1.2rem;
        color: var(--text-muted);
        font-style: italic;
        margin-bottom: 1rem;
    }

    .current-person .dates {
        font-size: 1rem;
        color: var(--text-color);
        margin-bottom: 1rem;
    }

    .current-person .description {
        font-style: italic;
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
    }

    .family-section {
        margin-bottom: 2rem;
    }

    .family-section h3 {
        font-size: 1.3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-family: "Crimson Text", serif;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.5rem;
    }

    .family-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .family-card {
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }

    .family-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }

    .family-card h4 {
        font-size: 1.1rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        font-family: "Crimson Text", serif;
    }

    .family-card .relationship {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    .family-card .dates {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .verses-section {
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--background-color);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .verses-section h3 {
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-family: "Crimson Text", serif;
    }

    .verse-item {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
    }

    .verse-item:hover {
        background: var(--hover-background);
        border-color: var(--primary-color);
    }

    .verse-reference {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        font-family: "Inter", sans-serif;
    }

    .verse-reference a {
        color: inherit;
        text-decoration: none;
    }

    .verse-reference a:hover {
        text-decoration: underline;
    }

    .verse-text {
        font-family: "Crimson Text", serif;
        font-size: 1rem;
        line-height: 1.6;
        color: var(--text-color);
        font-style: italic;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--background-color);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        text-align: center;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
        font-family: "Crimson Text", serif;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    @media (max-width: 1024px) {
        .explorer-layout {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .person-index {
            max-height: 40vh;
            order: 2;
        }

        .family-viewer {
            order: 1;
            min-height: auto;
        }
    }

    @media (max-width: 768px) {
        .family-explorer-header h1 {
            font-size: 2rem;
        }

        .explorer-layout {
            grid-template-columns: 1fr;
        }

        .person-index {
            max-height: 50vh;
        }

        .family-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Dark mode adjustments */
    @media (prefers-color-scheme: dark) {
        .family-explorer-header {
            background: linear-gradient(135deg, #2d1b69, #8b5a2b);
        }
    }
</style>
{% endblock %} 

{% block content %}
<div class="family-explorer-container">
    <header class="family-explorer-header">
        <h1>🌳 Biblical Family Tree Explorer</h1>
        <p>
            Explore biblical genealogies with an interactive person index. 
            Click on any person to see their family relationships and scripture references.
        </p>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="total-persons">0</div>
            <div class="stat-label">Total Persons</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-families">0</div>
            <div class="stat-label">Family Groups</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-generations">0</div>
            <div class="stat-label">Generations</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="selected-generation">-</div>
            <div class="stat-label">Selected Person</div>
        </div>
    </div>

    <div class="explorer-layout">
        <div class="person-index">
            <div class="index-header">
                <h2>📜 Person Index</h2>
                <input 
                    type="text" 
                    class="search-box" 
                    id="person-search" 
                    placeholder="Search by name..."
                    onkeyup="filterPersons()"
                >
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByLineage('all')">All</button>
                    <button class="filter-btn" onclick="filterByLineage('seth')">Seth's Line</button>
                    <button class="filter-btn" onclick="filterByLineage('cain')">Cain's Line</button>
                    <button class="filter-btn" onclick="filterByLineage('noah')">Noah's Sons</button>
                </div>
            </div>
            <ul class="person-list" id="person-list">
                <!-- Persons will be populated by JavaScript -->
            </ul>
        </div>

        <div class="family-viewer">
            <div class="welcome-message" id="welcome-message">
                <h3>👈 Select a Person</h3>
                <p>Choose someone from the person index to explore their family relationships and see relevant scripture passages.</p>
                <p>The biblical genealogies contain {{ family_tree_data|length }} individuals spanning many generations from Adam to the patriarchs of Israel.</p>
            </div>

            <div class="view-toggle" id="view-toggle" style="display: none;">
                <button class="view-btn active" onclick="showDetailsView()">📋 Details View</button>
                <button class="view-btn" onclick="showTreeView()">🌳 Tree View</button>
            </div>

            <div id="person-details" style="display: none;">
                <div class="current-person">
                    <h2 id="current-name"></h2>
                    <div class="title" id="current-title"></div>
                    <div class="dates" id="current-dates"></div>
                    <div class="description" id="current-description"></div>
                </div>

                <div class="family-section" id="parents-section" style="display: none;">
                    <h3>👨‍👩‍👧‍👦 Parents</h3>
                    <div class="family-grid" id="parents-grid"></div>
                </div>

                <div class="family-section" id="spouse-section" style="display: none;">
                    <h3>💑 Spouse</h3>
                    <div class="family-grid" id="spouse-grid"></div>
                </div>

                <div class="family-section" id="children-section" style="display: none;">
                    <h3>👶 Children</h3>
                    <div class="family-grid" id="children-grid"></div>
                </div>

                <div class="verses-section" id="verses-section" style="display: none;">
                    <h3>📖 Scripture References</h3>
                    <div id="verses-list"></div>
                </div>
            </div>

            <div class="tree-view" id="tree-view">
                <div class="nuclear-family-container">
                    <div class="nuclear-family-network" id="nuclear-family-network">
                        <!-- Family members will be positioned here by JavaScript -->
                    </div>
                    
                    <div class="family-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--primary-color);"></div>
                            <span>Current Person</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e8f5e8; border-color: #28a745;"></div>
                            <span>Spouse</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fff3cd; border-color: #ffc107;"></div>
                            <span>Parent</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f8d7da; border-color: #dc3545;"></div>
                            <span>Child</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Family tree data passed from the server
    const familyData = {{ family_tree_data | tojson }};
    let currentPersonId = null;
    let currentFilter = 'all';
    let allPersons = [];

    // Initialize the explorer
    document.addEventListener('DOMContentLoaded', function() {
        initializeExplorer();
    });

    function initializeExplorer() {
        // Convert family data to sorted array
        allPersons = Object.keys(familyData).map(id => ({
            id: id,
            ...familyData[id]
        })).sort((a, b) => a.name.localeCompare(b.name));

        // Update statistics
        updateStatistics();

        // Populate person list
        populatePersonList();

        // Select Adam by default if available
        const adamId = Object.keys(familyData).find(id => 
            familyData[id].name.toLowerCase() === 'adam'
        );
        if (adamId) {
            selectPerson(adamId);
        }
    }

    function updateStatistics() {
        document.getElementById('total-persons').textContent = allPersons.length;
        
        // Count families (people with children)
        const families = allPersons.filter(person => person.children && person.children.length > 0);
        document.getElementById('total-families').textContent = families.length;

        // Estimate generations (this is approximate)
        document.getElementById('total-generations').textContent = '12+';
    }

    function populatePersonList() {
        const personList = document.getElementById('person-list');
        personList.innerHTML = '';

        let filteredPersons = allPersons;

        // Apply search filter
        const searchTerm = document.getElementById('person-search').value.toLowerCase();
        if (searchTerm) {
            filteredPersons = filteredPersons.filter(person => 
                person.name.toLowerCase().includes(searchTerm) ||
                (person.title && person.title.toLowerCase().includes(searchTerm))
            );
        }

        // Apply lineage filter
        if (currentFilter !== 'all') {
            filteredPersons = filteredPersons.filter(person => {
                const lineage = determineLineage(person);
                return lineage === currentFilter;
            });
        }

        filteredPersons.forEach(person => {
            const listItem = document.createElement('li');
            listItem.className = 'person-item';
            if (currentPersonId === person.id) {
                listItem.classList.add('active');
            }
            
            const lineage = determineLineage(person);
            const generationInfo = getGenerationInfo(person);
            
            listItem.innerHTML = `
                <div class="person-name">${person.name}</div>
                <div class="person-title">${person.title || 'Biblical Figure'}</div>
                <div class="person-generation">${lineage} • ${generationInfo}</div>
            `;
            
            listItem.onclick = () => selectPerson(person.id);
            personList.appendChild(listItem);
        });

        if (filteredPersons.length === 0) {
            personList.innerHTML = '<li style="padding: 1rem; text-align: center; color: var(--text-muted);">No persons found</li>';
        }
    }

    function determineLineage(person) {
        // Simple lineage determination based on name patterns and known relationships
        const name = person.name.toLowerCase();
        
        // Known Cain's line
        if (['cain', 'enoch', 'irad', 'mehujael', 'methusael', 'lamech', 'jabal', 'jubal', 'tubalcain', 'naamah'].includes(name)) {
            return 'cain';
        }
        
        // Known Seth's line (main genealogy)
        if (['seth', 'enos', 'cainan', 'mahalaleel', 'jared', 'enoch', 'methuselah', 'lamech', 'noah'].includes(name)) {
            return 'seth';
        }
        
        // Noah's sons and their descendants
        if (['shem', 'ham', 'japheth'].includes(name) || person.parents?.some(p => ['shem', 'ham', 'japheth'].includes(familyData[p]?.name?.toLowerCase()))) {
            return 'noah';
        }
        
        return 'other';
    }

    function getGenerationInfo(person) {
        // Simplified generation calculation
        if (!person.birth_year || person.birth_year === 'Unknown') {
            return 'Generation unknown';
        }
        
        // Try to extract year from birth_year string
        const yearMatch = person.birth_year.match(/\d+/);
        if (yearMatch) {
            const year = parseInt(yearMatch[0]);
            if (year > 4000) return 'Generation 1-2';
            if (year > 3500) return 'Generation 3-5';
            if (year > 3000) return 'Generation 6-8';
            if (year > 2500) return 'Generation 9-11';
            return 'Later generations';
        }
        
        return 'Generation unknown';
    }

    function selectPerson(personId) {
        currentPersonId = personId;
        const person = familyData[personId];
        
        if (!person) return;

        // Update active state in person list
        document.querySelectorAll('.person-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Find and activate the current person in the list
        const personItems = document.querySelectorAll('.person-item');
        personItems.forEach(item => {
            if (item.querySelector('.person-name').textContent === person.name) {
                item.classList.add('active');
            }
        });

        // Hide welcome message and show person details
        document.getElementById('welcome-message').style.display = 'none';
        document.getElementById('view-toggle').style.display = 'flex';
        document.getElementById('person-details').style.display = 'block';

        // Update current person info
        document.getElementById('current-name').textContent = person.name;
        document.getElementById('current-title').textContent = person.title || 'Biblical Figure';
        
        // Update dates
        let datesText = '';
        if (person.birth_year !== 'Unknown' || person.death_year !== 'Unknown') {
            datesText = `${person.birth_year} - ${person.death_year}`;
            if (person.age_at_death !== 'Unknown') {
                datesText += ` (${person.age_at_death})`;
            }
        }
        document.getElementById('current-dates').textContent = datesText;
        
        document.getElementById('current-description').textContent = person.description;

        // Update selected person generation in stats
        document.getElementById('selected-generation').textContent = getGenerationInfo(person);

        // Show family sections
        showParents(person);
        showSpouse(person);
        showChildren(person);
        showVerses(person);
        
        // Update tree view
        updateTreeView(person, personId);
    }

    function showParents(person) {
        const parentsSection = document.getElementById('parents-section');
        const parentsGrid = document.getElementById('parents-grid');
        
        if (person.parents && person.parents.length > 0) {
            parentsSection.style.display = 'block';
            parentsGrid.innerHTML = '';
            
            person.parents.forEach(parentId => {
                const parent = familyData[parentId];
                if (parent) {
                    const card = createFamilyCard(parent, parentId, 'Parent');
                    parentsGrid.appendChild(card);
                }
            });
        } else {
            parentsSection.style.display = 'none';
        }
    }

    function showSpouse(person) {
        const spouseSection = document.getElementById('spouse-section');
        const spouseGrid = document.getElementById('spouse-grid');
        
        if (person.spouse) {
            spouseSection.style.display = 'block';
            spouseGrid.innerHTML = '';
            
            // Find spouse by name
            const spouseId = Object.keys(familyData).find(id => 
                familyData[id].name === person.spouse
            );
            
            if (spouseId) {
                const spouse = familyData[spouseId];
                const card = createFamilyCard(spouse, spouseId, 'Spouse');
                spouseGrid.appendChild(card);
            }
        } else {
            spouseSection.style.display = 'none';
        }
    }

    function showChildren(person) {
        const childrenSection = document.getElementById('children-section');
        const childrenGrid = document.getElementById('children-grid');
        
        if (person.children && person.children.length > 0) {
            childrenSection.style.display = 'block';
            childrenGrid.innerHTML = '';
            
            person.children.forEach(childId => {
                const child = familyData[childId];
                if (child) {
                    const card = createFamilyCard(child, childId, 'Child');
                    childrenGrid.appendChild(card);
                }
            });
        } else {
            childrenSection.style.display = 'none';
        }
    }

    function createFamilyCard(person, personId, relationship) {
        const card = document.createElement('div');
        card.className = 'family-card';
        card.onclick = () => selectPerson(personId);
        
        let datesText = '';
        if (person.birth_year !== 'Unknown' || person.death_year !== 'Unknown') {
            datesText = `${person.birth_year} - ${person.death_year}`;
        }
        
        card.innerHTML = `
            <h4>${person.name}</h4>
            <div class="relationship">${relationship}</div>
            <div class="dates">${datesText}</div>
        `;
        
        return card;
    }

    function showVerses(person) {
        const versesSection = document.getElementById('verses-section');
        const versesList = document.getElementById('verses-list');
        
        if (person.verses && person.verses.length > 0) {
            versesSection.style.display = 'block';
            versesList.innerHTML = '';
            
            person.verses.forEach(verse => {
                const verseItem = document.createElement('div');
                verseItem.className = 'verse-item';
                
                const bookChapter = verse.reference.split(' ');
                const book = bookChapter[0];
                const chapter = bookChapter[1] ? bookChapter[1].split(':')[0] : '';
                
                verseItem.innerHTML = `
                    <div class="verse-reference">
                        <a href="/book/${book}${chapter ? '/chapter/' + chapter : ''}">${verse.reference}</a>
                    </div>
                    <div class="verse-text">${verse.text}</div>
                `;
                
                versesList.appendChild(verseItem);
            });
        } else {
            versesSection.style.display = 'none';
        }
    }

    function filterPersons() {
        populatePersonList();
    }

    function filterByLineage(lineage) {
        currentFilter = lineage;
        
        // Update active filter button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        populatePersonList();
    }

    function showDetailsView() {
        document.getElementById('person-details').style.display = 'block';
        document.getElementById('tree-view').style.display = 'none';
        
        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('button[onclick="showDetailsView()"]').classList.add('active');
    }

    function showTreeView() {
        document.getElementById('person-details').style.display = 'none';
        document.getElementById('tree-view').style.display = 'block';
        
        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('button[onclick="showTreeView()"]').classList.add('active');
    }

    function createFamilyMember(person, personId, role, position) {
        const member = document.createElement('div');
        member.className = `family-member ${role}`;
        member.onclick = () => selectPerson(personId);
        member.style.left = `${position.x}px`;
        member.style.top = `${position.y}px`;
        
        member.innerHTML = `
            <div class="name">${person.name}</div>
            <div class="role">${role}</div>
        `;
        
        return member;
    }

    function createConnectionLine(from, to, type) {
        const line = document.createElement('div');
        line.className = `connection-line ${type}`;
        
        const fromRect = from.getBoundingClientRect();
        const toRect = to.getBoundingClientRect();
        const containerRect = document.getElementById('nuclear-family-network').getBoundingClientRect();
        
        const fromX = fromRect.left - containerRect.left + fromRect.width / 2;
        const fromY = fromRect.top - containerRect.top + fromRect.height / 2;
        const toX = toRect.left - containerRect.left + toRect.width / 2;
        const toY = toRect.top - containerRect.top + toRect.height / 2;
        
        if (type === 'marriage') {
            // Horizontal line for marriage
            const minX = Math.min(fromX, toX);
            const maxX = Math.max(fromX, toX);
            line.style.left = `${minX}px`;
            line.style.top = `${fromY}px`;
            line.style.width = `${maxX - minX}px`;
        } else {
            // Vertical line for parent-child relationships
            const minY = Math.min(fromY, toY);
            const maxY = Math.max(fromY, toY);
            line.style.left = `${fromX}px`;
            line.style.top = `${minY}px`;
            line.style.height = `${maxY - minY}px`;
        }
        
        return line;
    }

    function updateTreeView(person, personId) {
        const network = document.getElementById('nuclear-family-network');
        network.innerHTML = '';
        
        // Responsive positioning based on container size
        const container = network.getBoundingClientRect();
        const containerWidth = container.width - 100; // Account for padding
        const containerHeight = container.height - 100;
        
        const positions = {
            current: { x: containerWidth * 0.3, y: containerHeight * 0.4 },
            spouse: { x: containerWidth * 0.6, y: containerHeight * 0.4 },
            parent1: { x: containerWidth * 0.2, y: containerHeight * 0.1 },
            parent2: { x: containerWidth * 0.5, y: containerHeight * 0.1 },
            children: []
        };
        
        const members = [];
        
        // Add current person
        const currentMember = createFamilyMember(person, personId, 'current', positions.current);
        network.appendChild(currentMember);
        members.push({ element: currentMember, role: 'current' });
        
        // Add spouse if exists
        let spouseMember = null;
        if (person.spouse) {
            const spouseId = Object.keys(familyData).find(id => familyData[id].name === person.spouse);
            if (spouseId) {
                const spouse = familyData[spouseId];
                spouseMember = createFamilyMember(spouse, spouseId, 'spouse', positions.spouse);
                network.appendChild(spouseMember);
                members.push({ element: spouseMember, role: 'spouse' });
            }
        }
        
        // Add parents
        const parentMembers = [];
        if (person.parents && person.parents.length > 0) {
            person.parents.forEach((parentId, index) => {
                const parent = familyData[parentId];
                if (parent) {
                    const pos = index === 0 ? positions.parent1 : positions.parent2;
                    const parentMember = createFamilyMember(parent, parentId, 'parent', pos);
                    network.appendChild(parentMember);
                    parentMembers.push(parentMember);
                    members.push({ element: parentMember, role: 'parent' });
                }
            });
        }
        
        // Add children
        const childMembers = [];
        if (person.children && person.children.length > 0) {
            const childStartX = containerWidth * 0.15;
            const childSpacing = Math.min(120, containerWidth * 0.15);
            
            person.children.forEach((childId, index) => {
                const child = familyData[childId];
                if (child) {
                    const childPos = { x: childStartX + (index * childSpacing), y: containerHeight * 0.7 };
                    const childMember = createFamilyMember(child, childId, 'child', childPos);
                    network.appendChild(childMember);
                    childMembers.push(childMember);
                    members.push({ element: childMember, role: 'child' });
                    positions.children.push(childPos);
                }
            });
        }
        
        // Wait for elements to be rendered, then add connection lines
        setTimeout(() => {
            // Marriage line
            if (spouseMember) {
                const marriageLine = createConnectionLine(currentMember, spouseMember, 'marriage');
                network.appendChild(marriageLine);
            }
            
            // Parent-child lines
            parentMembers.forEach(parentMember => {
                const parentChildLine = createConnectionLine(parentMember, currentMember, 'parent-child');
                network.appendChild(parentChildLine);
            });
            
            // Current person to children lines
            childMembers.forEach(childMember => {
                const childLine = createConnectionLine(currentMember, childMember, 'parent-child');
                network.appendChild(childLine);
            });
            
            // Spouse to children lines (if spouse exists)
            if (spouseMember) {
                childMembers.forEach(childMember => {
                    const spouseChildLine = createConnectionLine(spouseMember, childMember, 'parent-child');
                    network.appendChild(spouseChildLine);
                });
            }
        }, 100);
    }
</script>
{% endblock %}