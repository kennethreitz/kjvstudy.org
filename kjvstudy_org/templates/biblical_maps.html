{% extends "base.html" %}

{% block title %}Biblical Maps - KJV Study{% endblock %}

{% block description %}Explore the geographical context of Scripture with interactive biblical maps showing locations, journeys, and historical events from both the Old and New Testaments.{% endblock %}

{% block keywords %}biblical maps, Bible geography, biblical locations, Jerusalem, Holy Land, Paul's journeys, Old Testament maps, New Testament maps{% endblock %}

{% block extra_head %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        .maps-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .maps-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .maps-header h1 {
            color: var(--primary-light);
            margin-bottom: 10px;
            font-family: var(--font-display);
        }
        
        .maps-header p {
            color: var(--text-secondary);
            font-size: 16px;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .info-panel {
            background: rgba(75, 46, 131, 0.1);
            border: 1px solid var(--primary-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }
        
        .info-panel h3 {
            color: var(--primary-light);
            margin: 0 0 10px 0;
            font-family: var(--font-display);
        }
        
        .info-panel p {
            margin: 0;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        
        #biblical-map {
            height: 600px !important;
            width: 100% !important;
            border: 2px solid var(--primary-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            margin: 20px 0;
            background: #333 !important;
            display: block !important;
            position: relative !important;
        }
        
        .map-legend {
            background: var(--surface-color);
            padding: 15px;
            border-radius: var(--radius-lg);
            margin-top: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        
        .map-legend h3 {
            margin: 0 0 10px 0;
            color: var(--primary-light);
            font-family: var(--font-display);
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }
        
        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            font-size: 10px;
        }
        
        /* Dark theme for Leaflet popups */
        .leaflet-popup-content-wrapper {
            background: var(--surface-color) !important;
            color: var(--text-primary) !important;
            border-radius: var(--radius-md) !important;
        }
        
        .leaflet-popup-tip {
            background: var(--surface-color) !important;
        }
        
        .leaflet-control-layers {
            background: var(--surface-color) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        .leaflet-control-layers-list {
            color: var(--text-primary) !important;
        }
        
        @media (max-width: 768px) {
            .maps-container {
                padding: 10px;
            }
            
            #biblical-map {
                height: 400px;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="maps-container">
    <div class="maps-header">
        <h1>üó∫Ô∏è Biblical Maps</h1>
        <p>Explore the geographical context of Scripture with interactive maps showing biblical locations, journeys, and historical events from both the Old and New Testaments.</p>
    </div>

    <div class="info-panel">
        <h3>üìç How to Use Biblical Maps</h3>
        <p>Click on map markers to learn about biblical locations and their significance. Use the layer controls to switch between different map styles. Each location includes relevant Scripture references you can click to explore further.</p>
    </div>

    <div id="biblical-map">
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--surface-color); color: var(--text-secondary); font-size: 18px; border-radius: var(--radius-lg);">
            üìç Loading Biblical Maps...
        </div>
    </div>

    <div class="map-legend">
        <h3>üó∫Ô∏è Map Legend</h3>
        <div class="legend-items">
            <div class="legend-item">
                <div class="legend-icon" style="background-color: #8B4513;">üèõÔ∏è</div>
                <span>Biblical Cities</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background-color: #8B7355;">‚õ∞Ô∏è</div>
                <span>Mountains & High Places</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background-color: #4682B4;">üåä</div>
                <span>Bodies of Water</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background-color: #DAA520;">üïå</div>
                <span>Temples & Holy Sites</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background-color: #DC143C;">‚ú®</div>
                <span>Major Biblical Events</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting map initialization...');
            
            // Check if container exists
            const container = document.getElementById('biblical-map');
            if (!container) {
                console.error('Map container not found!');
                return;
            }
            console.log('Map container found:', container);
            
            // Clear loading message
            container.innerHTML = '';
            
            // Initialize map with error handling
            let map;
            try {
                map = L.map('biblical-map').setView([31.7683, 35.2137], 7);
                console.log('Map object created successfully');
            } catch (error) {
                console.error('Error creating map:', error);
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--surface-color); color: #ff6b6b; font-size: 18px; border-radius: var(--radius-lg);">‚ùå Error loading map</div>';
                return;
            }
            
            // Add tile layers with error handling
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgdmlld0JveD0iMCAwIDI1NiAyNTYiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiBmaWxsPSIjMzMzIi8+Cjx0ZXh0IHg9IjEyOCIgeT0iMTI4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmIiBmb250LXNpemU9IjE0Ij5NYXAgVGlsZTwvdGV4dD4KPC9zdmc+'
            });
            
            const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgdmlld0JveD0iMCAwIDI1NiAyNTYiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiBmaWxsPSIjMjIyIi8+Cjx0ZXh0IHg9IjEyOCIgeT0iMTI4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmIiBmb250LXNpemU9IjE0Ij5EYXJrIE1hcDwvdGV4dD4KPC9zdmc+'
            });
            
            // Add OSM layer by default (more reliable)
            osmLayer.addTo(map);
            console.log('Tile layer added to map');
            
            // Layer control
            const baseLayers = {
                "Standard": osmLayer,
                "Dark Theme": darkLayer
            };
            
            L.control.layers(baseLayers).addTo(map);
            console.log('Layer control added');
            
            // Biblical locations
            const locations = [
                {
                    name: "Jerusalem",
                    coords: [31.7683, 35.2137],
                    description: "The holy city, site of Solomon's Temple and Jesus's crucifixion",
                    verses: ["2 Samuel 5:6-7", "1 Kings 6:1", "Matthew 27:33"],
                    icon: "üèõÔ∏è"
                },
                {
                    name: "Bethlehem",
                    coords: [31.7054, 35.2024],
                    description: "City of David's birth and Jesus's birth",
                    verses: ["1 Samuel 16:1", "Micah 5:2", "Matthew 2:1"],
                    icon: "üèõÔ∏è"
                },
                {
                    name: "Nazareth", 
                    coords: [32.7009, 35.2976],
                    description: "Jesus's hometown",
                    verses: ["Matthew 2:23", "Luke 1:26", "Luke 4:16"],
                    icon: "üèõÔ∏è"
                },
                {
                    name: "Capernaum",
                    coords: [32.8819, 35.5747],
                    description: "Jesus's ministry headquarters",
                    verses: ["Matthew 4:13", "Matthew 8:5", "Mark 2:1"],
                    icon: "üèõÔ∏è"
                },
                {
                    name: "Damascus",
                    coords: [33.5138, 36.2765],
                    description: "Ancient city, site of Paul's conversion",
                    verses: ["2 Kings 5:12", "Acts 9:3"],
                    icon: "üèõÔ∏è"
                },
                {
                    name: "Rome",
                    coords: [41.9028, 12.4964],
                    description: "Capital of Roman Empire, Paul's final destination",
                    verses: ["Acts 28:16", "Romans 1:7"],
                    icon: "üèõÔ∏è"
                },
                {
                    name: "Athens",
                    coords: [37.9755, 23.7348],
                    description: "Paul preached at the Areopagus",
                    verses: ["Acts 17:16-34"],
                    icon: "üèõÔ∏è"
                },
                {
                    name: "Corinth",
                    coords: [37.9065, 22.8756],
                    description: "Paul established church and wrote letters",
                    verses: ["Acts 18:1", "1 Corinthians 1:2"],
                    icon: "üèõÔ∏è"
                },
                {
                    name: "Ephesus",
                    coords: [37.9495, 27.3517],
                    description: "Major center of Paul's ministry",
                    verses: ["Acts 19:1", "Ephesians 1:1", "Revelation 2:1"],
                    icon: "üèõÔ∏è"
                },
                {
                    name: "Sea of Galilee",
                    coords: [32.8219, 35.5881],
                    description: "Where Jesus called disciples and performed miracles",
                    verses: ["Matthew 4:18", "Mark 6:47-52", "John 21:1"],
                    icon: "üåä"
                },
                {
                    name: "Mount Sinai",
                    coords: [28.5394, 33.9731],
                    description: "Where Moses received the Ten Commandments",
                    verses: ["Exodus 19:20", "Exodus 24:16", "Deuteronomy 4:10"],
                    icon: "‚õ∞Ô∏è"
                },
                {
                    name: "Mount Carmel",
                    coords: [32.7319, 35.0478],
                    description: "Site of Elijah's contest with Baal's prophets",
                    verses: ["1 Kings 18:19-40"],
                    icon: "‚õ∞Ô∏è"
                }
            ];
            
            // Add markers
            locations.forEach(function(location) {
                const verseLinks = location.verses.map(verse => 
                    `<a href="/search?q=${encodeURIComponent(verse)}" style="color: #6d4bb3; text-decoration: none;">${verse}</a>`
                ).join(', ');
                
                const popupContent = `
                    <div style="font-family: 'Crimson Text', serif; min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; color: #6d4bb3; font-size: 16px; border-bottom: 1px solid #2a2a2a; padding-bottom: 4px;">${location.name}</h3>
                        <p style="margin: 8px 0; font-size: 14px; color: #a3a3a3;">${location.description}</p>
                        <div style="margin-top: 10px; font-size: 12px; color: #737373;">
                            <strong>Key Verses:</strong><br>
                            ${verseLinks}
                        </div>
                    </div>
                `;
                
                const marker = L.marker(location.coords).addTo(map);
                marker.bindPopup(popupContent, {
                    maxWidth: 300,
                    className: 'biblical-location-popup'
                });
            });
            
            console.log('Biblical maps loaded successfully with', locations.length, 'locations');
            
            // Force map resize after a short delay
            setTimeout(function() {
                map.invalidateSize();
                console.log('Map size invalidated');
            }, 100);
        });
    </script>
{% endblock %}