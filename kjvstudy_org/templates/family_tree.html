{% extends "base.html" %}
{% block title %}Biblical Family Tree Explorer - KJV Study{% endblock %}
{% block description %}Explore biblical genealogies with an interactive person index and family tree viewer. Browse from Adam to the patriarchs with detailed family relationships.{% endblock %}
{% block keywords %}biblical family tree, biblical genealogy, Adam and Eve, patriarchs, biblical lineage, Old Testament families, KJV genealogy{% endblock %}
{% block og_title %}Biblical Family Tree Explorer - KJV Study{% endblock %}

{% block head %}
<!-- D3.js Library -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Font Awesome for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Font Awesome for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
    .family-explorer-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
    }

    .family-explorer-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem 1rem;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 12px;
        color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .family-explorer-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        font-family: "Crimson Text", serif;
    }

    .family-explorer-header p {
        font-size: 1.1rem;
        opacity: 0.9;
        max-width: 700px;
        margin: 0 auto;
    }

    .explorer-layout {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    .person-index {
        background: var(--card-background);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        height: fit-content;
        max-height: 80vh;
        overflow-y: auto;
    }

    .index-header {
        margin-bottom: 1.5rem;
    }

    .index-header h2 {
        color: var(--primary-color);
        font-family: "Crimson Text", serif;
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }

    .search-box {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
        background: var(--background-color);
        color: var(--text-color);
        margin-bottom: 1rem;
    }

    .search-box:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(75, 46, 131, 0.1);
    }

    .filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .filter-btn {
        padding: 0.4rem 0.8rem;
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.2s ease;
    }

    .filter-btn:hover,
    .filter-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .person-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .person-item {
        padding: 0.75rem;
        cursor: pointer;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .person-item:hover {
        background: var(--hover-background);
        border-color: var(--border-color);
    }

    .person-item.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .person-name {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }

    .person-title {
        font-size: 0.8rem;
        opacity: 0.8;
        margin-bottom: 0.25rem;
    }

    .person-generation {
        font-size: 0.7rem;
        opacity: 0.6;
    }

    .family-viewer {
        background: var(--card-background);
        border-radius: 12px;
        padding: 2rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        min-height: 80vh;
    }

    .view-toggle {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        gap: 0.5rem;
    }

    .view-btn {
        padding: 0.5rem 1rem;
        border: 2px solid var(--primary-color);
        background: transparent;
        color: var(--primary-color);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .view-btn.active {
        background: var(--primary-color);
        color: white;
    }

    .view-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    .tree-view {
        display: block;
        margin-top: 2rem;
    }

    .details-view {
        display: none;
    }

    .comprehensive-person-view {
        background: var(--card-background);
        border-radius: 12px;
        padding: 2rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-top: 2rem;
        display: block;
    }

    .person-header {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--border-color);
    }

    .person-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: white;
        flex-shrink: 0;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        border: 3px solid rgba(255, 255, 255, 0.2);
    }

    .person-avatar.male {
        background: linear-gradient(135deg, #74b9ff, #0984e3);
    }

    .person-avatar.female {
        background: linear-gradient(135deg, #fd79a8, #e84393);
    }

    .person-basic-info h1 {
        font-size: 2.2rem;
        margin: 0 0 0.5rem 0;
        color: var(--text-color);
        font-family: 'Crimson Text', serif;
    }

    .person-basic-info .person-title {
        font-size: 1.1rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        font-style: italic;
    }

    .person-basic-info .person-lifespan {
        font-size: 1rem;
        color: var(--primary-color);
        font-weight: 600;
    }

    .data-sections {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .data-section {
        background: var(--background-color);
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
    }

    .data-section h3 {
        font-size: 1.3rem;
        margin: 0 0 1rem 0;
        color: var(--primary-color);
        font-family: 'Crimson Text', serif;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--border-color);
    }

    .gedcom-field {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }

    .gedcom-field:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .field-label {
        font-weight: 600;
        color: var(--text-color);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .field-value {
        color: var(--text-muted);
        line-height: 1.5;
    }

    .scripture-references {
        grid-column: 1 / -1;
    }

    .verse-reference-item {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid var(--primary-color);
    }

    .verse-ref {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .verse-ref a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .verse-ref a:hover {
        text-decoration: underline;
    }

    .verse-text {
        font-family: 'Crimson Text', serif;
        font-style: italic;
        line-height: 1.6;
        color: var(--text-color);
    }

    .family-connections {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .connection-card {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .connection-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .connection-card .connection-name {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }

    .connection-card .connection-type {
        font-size: 0.8rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    @media (max-width: 768px) {
        .data-sections {
            grid-template-columns: 1fr;
        }

        .person-header {
            flex-direction: column;
            text-align: center;
        }

        .person-basic-info h1 {
            font-size: 1.8rem;
        }

        .family-connections {
            grid-template-columns: 1fr;
        }
    }

    .d3-tree-container {
        width: 100%;
        height: 600px;
        background: var(--background-color);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        position: relative;
    }

    .d3-tree-svg {
        width: 100%;
        height: 100%;
    }

    .tree-node {
        cursor: pointer;
    }

    .tree-node circle {
        fill: #2d3436;
        stroke: #ffc107;
        stroke-width: 3px;
        transition: all 0.3s ease;
    }

    .tree-node.current circle {
        fill: #ffc107;
        stroke: #ffc107;
        stroke-width: 4px;
    }

    .tree-node.male circle {
        fill: #2d3436;
        stroke: #74b9ff;
        stroke-width: 3px;
    }

    .tree-node.female circle {
        fill: #2d3436;
        stroke: #fd79a8;
        stroke-width: 3px;
    }

    .tree-node.current.male circle {
        fill: #74b9ff;
        stroke: #74b9ff;
        stroke-width: 4px;
    }

    .tree-node.current.female circle {
        fill: #fd79a8;
        stroke: #fd79a8;
        stroke-width: 4px;
    }

    .tree-node.spouse circle {
        fill: #2d3436;
        stroke: #28a745;
    }

    .tree-node.parent circle {
        fill: #2d3436;
        stroke: #74b9ff;
    }

    .tree-node.child circle {
        fill: #2d3436;
        stroke: #fd79a8;
    }

    .tree-node:hover circle {
        r: 8;
        stroke-width: 4px;
    }

    .tree-node text {
        font: 12px sans-serif;
        fill: #f8f9fa;
        text-anchor: middle;
        dominant-baseline: central;
        pointer-events: none;
    }

    .tree-node.current text {
        fill: #2d3436;
        font-weight: bold;
    }

    .tree-node.current.male text {
        fill: white;
        font-weight: bold;
    }

    .tree-node.current.female text {
        fill: white;
        font-weight: bold;
    }

    .tree-link {
        fill: none;
        stroke: #636e72;
        stroke-width: 2px;
    }

    .tree-link.marriage {
        stroke: #00b894;
        stroke-width: 3px;
        stroke-dasharray: 5,5;
    }

    .tree-controls {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: #2d3436;
        border: 1px solid #636e72;
        border-radius: 8px;
        padding: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .gender-legend {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: #2d3436;
        border: 1px solid #636e72;
        border-radius: 8px;
        padding: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        font-size: 0.8rem;
        color: #f8f9fa;
    }

    .legend-title {
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #ffc107;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .legend-item:last-child {
        margin-bottom: 0;
    }

    .legend-circle {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid;
    }

    .legend-circle.male {
        background: #2d3436;
        border-color: #74b9ff;
    }

    .legend-circle.female {
        background: #2d3436;
        border-color: #fd79a8;
    }

    .legend-circle.current {
        background: #ffc107;
        border-color: #ffc107;
    }

    .tree-controls button {
        margin: 0.25rem;
        padding: 0.25rem 0.5rem;
        border: 1px solid #636e72;
        background: #2d3436;
        color: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .tree-controls button:hover {
        background: #ffc107;
        color: #2d3436;
        border-color: #ffc107;
    }

    @media (max-width: 768px) {
        .d3-tree-container {
            height: 400px;
        }

        .tree-node text {
            font-size: 10px;
        }

        .tree-controls {
            padding: 0.25rem;
        }

        .tree-controls button {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }

        .gender-legend {
            font-size: 0.7rem;
            padding: 0.5rem;
        }
    }

    .welcome-message {
        text-align: center;
        color: var(--text-muted);
        padding: 4rem 2rem;
    }

    .welcome-message h3 {
        color: var(--primary-color);
        font-family: "Crimson Text", serif;
        margin-bottom: 1rem;
    }

    .current-person {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: var(--background-color);
        border-radius: 8px;
        border: 2px solid var(--primary-color);
    }

    .current-person h2 {
        font-size: 2rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        font-family: "Crimson Text", serif;
    }

    .current-person .title {
        font-size: 1.2rem;
        color: var(--text-muted);
        font-style: italic;
        margin-bottom: 1rem;
    }

    .current-person .dates {
        font-size: 1rem;
        color: var(--text-color);
        margin-bottom: 1rem;
    }

    .current-person .description {
        font-style: italic;
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
    }

    .family-section {
        margin-bottom: 2rem;
    }

    .family-section h3 {
        font-size: 1.3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-family: "Crimson Text", serif;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.5rem;
    }

    .family-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .family-card {
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }

    .family-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }

    .family-card h4 {
        font-size: 1.1rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        font-family: "Crimson Text", serif;
    }

    .family-card .relationship {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    .family-card .dates {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .verses-section {
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--background-color);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .verses-section h3 {
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-family: "Crimson Text", serif;
    }

    .verse-item {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
    }

    .verse-item:hover {
        background: var(--hover-background);
        border-color: var(--primary-color);
    }

    .verse-reference {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        font-family: "Inter", sans-serif;
    }

    .verse-reference a {
        color: inherit;
        text-decoration: none;
    }

    .verse-reference a:hover {
        text-decoration: underline;
    }

    .verse-text {
        font-family: "Crimson Text", serif;
        font-size: 1rem;
        line-height: 1.6;
        color: var(--text-color);
        font-style: italic;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--background-color);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        text-align: center;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
        font-family: "Crimson Text", serif;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    @media (max-width: 1024px) {
        .explorer-layout {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .person-index {
            max-height: 40vh;
            order: 2;
        }

        .family-viewer {
            order: 1;
            min-height: auto;
        }
    }

    @media (max-width: 768px) {
        .family-explorer-header h1 {
            font-size: 2rem;
        }

        .explorer-layout {
            grid-template-columns: 1fr;
        }

        .person-index {
            max-height: 50vh;
        }

        .family-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Dark mode adjustments */
    /* Enhanced Features Styles */
    .layout-btn {
        padding: 8px 16px;
        border: 1px solid #dee2e6;
        background: white;
        color: #495057;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .layout-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    .layout-btn:hover {
        border-color: #007bff;
        color: #007bff;
        transform: translateY(-1px);
    }

    .layout-btn.active:hover {
        background: #0056b3;
        color: white;
    }

    .tree-node.search-highlight circle {
        stroke: #ff9800 !important;
        stroke-width: 4px !important;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { stroke-opacity: 1; }
        50% { stroke-opacity: 0.5; }
        100% { stroke-opacity: 1; }
    }

    .radial-link {
        stroke: #666;
        stroke-width: 2;
        fill: none;
        opacity: 0.7;
    }

    .force-link {
        stroke: #999;
        stroke-opacity: 0.6;
    }

    .force-link.marriage {
        stroke: #4caf50;
        stroke-width: 3px;
        stroke-dasharray: 5,5;
    }

    .force-node {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .force-node:hover circle {
        stroke-width: 3px;
        r: 10;
    }

    .search-btn:hover {
        background: #0056b3 !important;
        transform: translateY(-1px);
    }

    .close-btn:hover {
        opacity: 0.7;
        transform: scale(1.1);
    }

    @media (prefers-color-scheme: dark) {
        .family-explorer-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
        }
        
        .layout-btn {
            background: #2d3436;
            border-color: #636e72;
            color: #ddd;
        }
        
        .search-panel, .analytics-panel {
            background: #2d3436 !important;
            border-color: #636e72 !important;
            color: #ddd;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="family-explorer-container">
    <header class="family-explorer-header">
        <h1>üå≥ Biblical Family Tree Explorer</h1>
        <p>
            Explore biblical genealogies with an interactive person index.
            Click on any person to see their family relationships and scripture references.
        </p>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="total-persons">0</div>
            <div class="stat-label">Total Persons</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-families">0</div>
            <div class="stat-label">Family Groups</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-generations">0</div>
            <div class="stat-label">Generations</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="selected-generation">-</div>
            <div class="stat-label">Selected Person</div>
        </div>
    </div>

    <div class="explorer-layout">
        <div class="person-index">
            <div class="index-header">
                <h2>üìú Person Index</h2>
                <input
                    type="text"
                    class="search-box"
                    id="person-search"
                    placeholder="Search by name..."
                    onkeyup="filterPersons()"
                >
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByLineage('all')">All</button>
                    <button class="filter-btn" onclick="filterByLineage('seth')">Seth's Line</button>
                    <button class="filter-btn" onclick="filterByLineage('cain')">Cain's Line</button>
                    <button class="filter-btn" onclick="filterByLineage('noah')">Noah's Sons</button>
                </div>
            </div>
            <ul class="person-list" id="person-list">
                <!-- Persons will be populated by JavaScript -->
            </ul>
        </div>

        <div class="family-viewer">
            <div class="welcome-message" id="welcome-message">
                <h3>üëà Select a Person</h3>
                <p>Choose someone from the person index to explore their family relationships and see relevant scripture passages.</p>
                <p>The biblical genealogies contain {{ family_tree_data|length }} individuals spanning many generations from Adam to the patriarchs of Israel.</p>
            </div>

            <div class="view-toggle" id="view-toggle" style="display: flex;">
                <button class="view-btn" onclick="showDetailsView()">üìã Simple View</button>
                <button class="view-btn active" onclick="showTreeView()">üå≥ Full Tree View</button>
            </div>

            <!-- Enhanced Layout Selector -->
            <div class="layout-selector" id="layout-selector" style="display: none; justify-content: center; gap: 10px; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <button class="layout-btn active" onclick="switchLayout('hierarchical')" title="Traditional family tree">
                    <i class="fas fa-sitemap"></i> Hierarchical
                </button>
                <button class="layout-btn" onclick="switchLayout('radial')" title="Generations in circles">
                    <i class="fas fa-sun"></i> Radial
                </button>
                <button class="layout-btn" onclick="switchLayout('force-directed')" title="Dynamic relationships">
                    <i class="fas fa-project-diagram"></i> Force-Directed
                </button>
                <button class="layout-btn" onclick="switchLayout('timeline')" title="Chronological view">
                    <i class="fas fa-timeline"></i> Timeline
                </button>
            </div>

            <!-- Enhanced Search Panel -->
            <div class="search-panel" id="search-panel" style="display: none; background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 20px 0;">
                <div class="search-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4><i class="fas fa-search"></i> Advanced Search</h4>
                    <button onclick="toggleSearch()" class="close-btn" style="background: none; border: none; font-size: 18px; cursor: pointer;">√ó</button>
                </div>
                <div class="search-input-wrapper" style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="enhanced-search-input" placeholder="Search by name, title, or description..." 
                           style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <button onclick="performEnhancedSearch()" class="search-btn" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Search
                    </button>
                </div>
                <div class="search-filters" style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="search-names" checked> Names
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="search-titles" checked> Titles
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="search-descriptions"> Descriptions
                    </label>
                </div>
                <div id="search-results" style="margin-top: 15px; max-height: 200px; overflow-y: auto;"></div>
            </div>

            <!-- Analytics Panel -->
            <div class="analytics-panel" id="analytics-panel" style="display: none; background: white; border: 1px solid #ddd; border-radius: 8px; margin: 20px 0;">
                <div class="analytics-header" style="background: #007bff; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <h4><i class="fas fa-chart-bar"></i> Family Tree Analytics</h4>
                    <button onclick="toggleAnalytics()" class="close-btn" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">√ó</button>
                </div>
                <div class="analytics-content" style="padding: 20px;">
                    <div class="stats-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div class="stat-number" id="total-persons" style="font-size: 24px; font-weight: bold; color: #007bff;">0</div>
                            <div class="stat-label" style="font-size: 12px; color: #6c757d;">Total Persons</div>
                        </div>
                        <div class="stat-card" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div class="stat-number" id="male-count" style="font-size: 24px; font-weight: bold; color: #2196F3;">0</div>
                            <div class="stat-label" style="font-size: 12px; color: #6c757d;">Male</div>
                        </div>
                        <div class="stat-card" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div class="stat-number" id="female-count" style="font-size: 24px; font-weight: bold; color: #E91E63;">0</div>
                            <div class="stat-label" style="font-size: 12px; color: #6c757d;">Female</div>
                        </div>
                        <div class="stat-card" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div class="stat-number" id="generations-count" style="font-size: 24px; font-weight: bold; color: #4CAF50;">0</div>
                            <div class="stat-label" style="font-size: 12px; color: #6c757d;">Generations</div>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 300px; background: #fafafa; border-radius: 8px; padding: 15px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="demo-chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="tree-view" id="tree-view">
                <div class="d3-tree-container">
                    <div class="tree-controls">
                        <button onclick="centerTree()">Center</button>
                        <button onclick="expandAll()">Expand All</button>
                        <button onclick="collapseAll()">Collapse All</button>
                        <button onclick="toggleSearch()" style="background: #28a745; color: white; margin-left: 10px;">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <button onclick="toggleAnalytics()" style="background: #fd7e14; color: white;">
                            <i class="fas fa-chart-bar"></i> Analytics
                        </button>
                        <button onclick="exportTree()" style="background: #6c757d; color: white;">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    <svg class="d3-tree-svg" id="tree-svg"></svg>
                    
                    <div class="gender-legend">
                        <div class="legend-title">Gender</div>
                        <div class="legend-item">
                            <div class="legend-circle male"></div>
                            <span>Male</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-circle female"></div>
                            <span>Female</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-circle current"></div>
                            <span>Current Person</span>
                        </div>
                    </div>
                </div>

                <div class="comprehensive-person-view" id="comprehensive-person-view" style="display: block;">
                    <div class="person-header">
                        <div class="person-avatar" id="person-avatar">üë§</div>
                        <div class="person-basic-info">
                            <h1 id="comp-person-name">Select a Person</h1>
                            <div class="person-title" id="comp-person-title"></div>
                            <div class="person-lifespan" id="comp-person-lifespan"></div>
                        </div>
                    </div>

                    <div class="data-sections">
                        <div class="data-section">
                            <h3>üìã Personal Information</h3>
                            <div id="personal-info-fields"></div>
                        </div>

                        <div class="data-section">
                            <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Relationships</h3>
                            <div id="family-relationships"></div>
                        </div>

                        <div class="data-section">
                            <h3>üìÖ Life Events</h3>
                            <div id="life-events"></div>
                        </div>

                        <div class="data-section">
                            <h3>üè∑Ô∏è GEDCOM Details</h3>
                            <div id="gedcom-technical"></div>
                        </div>

                        <div class="data-section">
                            <h3>üß¨ Genealogy Path</h3>
                            <div id="genealogy-path"></div>
                        </div>

                        <div class="data-section">
                            <h3>üìà Statistical Info</h3>
                            <div id="statistical-info"></div>
                        </div>

                        <div class="data-section scripture-references">
                            <h3>üìñ Scripture References</h3>
                            <div id="scripture-references"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="details-view" id="person-details">
                <div class="current-person">
                    <h2 id="current-name"></h2>
                    <div class="title" id="current-title"></div>
                    <div class="dates" id="current-dates"></div>
                    <div class="description" id="current-description"></div>
                </div>

                <div class="family-section" id="parents-section" style="display: none;">
                    <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parents</h3>
                    <div class="family-grid" id="parents-grid"></div>
                </div>

                <div class="family-section" id="spouse-section" style="display: none;">
                    <h3>üíë Spouse</h3>
                    <div class="family-grid" id="spouse-grid"></div>
                </div>

                <div class="family-section" id="children-section" style="display: none;">
                    <h3>üë∂ Children</h3>
                    <div class="family-grid" id="children-grid"></div>
                </div>

                <div class="verses-section" id="verses-section" style="display: none;">
                    <h3>üìñ Scripture References</h3>
                    <div id="verses-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Family tree data passed from the server
    const familyData = {{ family_tree_data | tojson }};
    let currentPersonId = null;
    let currentFilter = 'all';
    let allPersons = [];

    // Initialize the explorer
    document.addEventListener('DOMContentLoaded', function() {
        initializeExplorer();
    });

    function initializeExplorer() {
        // Convert family data to sorted array
        allPersons = Object.keys(familyData).map(id => ({
            id: id,
            ...familyData[id]
        })).sort((a, b) => a.name.localeCompare(b.name));

        // Update statistics
        updateStatistics();

        // Populate person list
        populatePersonList();

        // Select Adam by default if available
        const adamId = Object.keys(familyData).find(id =>
            familyData[id].name.toLowerCase() === 'adam'
        );
        if (adamId) {
            selectPerson(adamId);
        }
    }

    function updateStatistics() {
        document.getElementById('total-persons').textContent = allPersons.length;

        // Count families (people with children)
        const families = allPersons.filter(person => person.children && person.children.length > 0);
        document.getElementById('total-families').textContent = families.length;

        // Estimate generations (this is approximate)
        document.getElementById('total-generations').textContent = '12+';
    }

    function populatePersonList() {
        const personList = document.getElementById('person-list');
        personList.innerHTML = '';

        let filteredPersons = allPersons;

        // Apply search filter
        const searchTerm = document.getElementById('person-search').value.toLowerCase();
        if (searchTerm) {
            filteredPersons = filteredPersons.filter(person =>
                person.name.toLowerCase().includes(searchTerm) ||
                (person.title && person.title.toLowerCase().includes(searchTerm))
            );
        }

        // Apply lineage filter
        if (currentFilter !== 'all') {
            filteredPersons = filteredPersons.filter(person => {
                const lineage = determineLineage(person);
                return lineage === currentFilter;
            });
        }

        filteredPersons.forEach(person => {
            const listItem = document.createElement('li');
            listItem.className = 'person-item';
            if (currentPersonId === person.id) {
                listItem.classList.add('active');
            }

            const lineage = determineLineage(person);
            const generationInfo = getGenerationInfo(person);

            listItem.innerHTML = `
                <div class="person-name">${person.name}</div>
                <div class="person-title">${person.title || 'Biblical Figure'}</div>
                <div class="person-generation">${lineage} ‚Ä¢ ${generationInfo}</div>
            `;

            listItem.onclick = () => selectPerson(person.id);
            personList.appendChild(listItem);
        });

        if (filteredPersons.length === 0) {
            personList.innerHTML = '<li style="padding: 1rem; text-align: center; color: var(--text-muted);">No persons found</li>';
        }
    }

    function determineLineage(person) {
        // Simple lineage determination based on name patterns and known relationships
        const name = person.name.toLowerCase();

        // Known Cain's line
        if (['cain', 'enoch', 'irad', 'mehujael', 'methusael', 'lamech', 'jabal', 'jubal', 'tubalcain', 'naamah'].includes(name)) {
            return 'cain';
        }

        // Known Seth's line (main genealogy)
        if (['seth', 'enos', 'cainan', 'mahalaleel', 'jared', 'enoch', 'methuselah', 'lamech', 'noah'].includes(name)) {
            return 'seth';
        }

        // Noah's sons and their descendants
        if (['shem', 'ham', 'japheth'].includes(name) || person.parents?.some(p => ['shem', 'ham', 'japheth'].includes(familyData[p]?.name?.toLowerCase()))) {
            return 'noah';
        }

        return 'other';
    }

    function getGenerationInfo(person) {
        // Simplified generation calculation
        if (!person.birth_year || person.birth_year === 'Unknown') {
            return 'Generation unknown';
        }

        // Try to extract year from birth_year string
        const yearMatch = person.birth_year.match(/\d+/);
        if (yearMatch) {
            const year = parseInt(yearMatch[0]);
            if (year > 4000) return 'Generation 1-2';
            if (year > 3500) return 'Generation 3-5';
            if (year > 3000) return 'Generation 6-8';
            if (year > 2500) return 'Generation 9-11';
            return 'Later generations';
        }

        return 'Generation unknown';
    }

    function selectPerson(personId) {
        currentPersonId = personId;
        const person = familyData[personId];

        if (!person) return;

        // Update active state in person list
        document.querySelectorAll('.person-item').forEach(item => {
            item.classList.remove('active');
        });

        // Find and activate the current person in the list
        const personItems = document.querySelectorAll('.person-item');
        personItems.forEach(item => {
            if (item.querySelector('.person-name').textContent === person.name) {
                item.classList.add('active');
            }
        });

        // Hide welcome message and show tree view by default
        document.getElementById('welcome-message').style.display = 'none';
        document.getElementById('view-toggle').style.display = 'flex';

        // Show tree view by default
        if (document.getElementById('tree-view').style.display !== 'none') {
            updateD3Tree(person, personId);
        }

        // Update comprehensive person view
        updateComprehensiveView(person, personId);

        // Update current person info
        document.getElementById('current-name').textContent = person.name;
        document.getElementById('current-title').textContent = person.title || 'Biblical Figure';

        // Update dates
        let datesText = '';
        if (person.birth_year !== 'Unknown' || person.death_year !== 'Unknown') {
            datesText = `${person.birth_year} - ${person.death_year}`;
            if (person.age_at_death !== 'Unknown') {
                datesText += ` (${person.age_at_death})`;
            }
        }
        document.getElementById('current-dates').textContent = datesText;

        document.getElementById('current-description').textContent = person.description;

        // Update selected person generation in stats
        document.getElementById('selected-generation').textContent = getGenerationInfo(person);

        // Show family sections
        showParents(person);
        showSpouse(person);
        showChildren(person);
        showVerses(person);

        // Update D3 tree view
        updateD3Tree(person, personId);

        // Update comprehensive person view
        updateComprehensiveView(person, personId);
    }

    function updateComprehensiveView(person, personId) {
        const compView = document.getElementById('comprehensive-person-view');
        const avatar = document.getElementById('person-avatar');
        const name = document.getElementById('comp-person-name');
        const title = document.getElementById('comp-person-title');
        const lifespan = document.getElementById('comp-person-lifespan');

        // Ensure the comprehensive view is visible
        compView.style.display = 'block';

        // Update avatar
        const gender = determineGender(person);
        avatar.className = `person-avatar ${gender}`;
        avatar.textContent = gender === 'female' ? 'üë©' : 'üë®';

        // Update basic info
        name.textContent = person.name || 'Unknown';
        title.textContent = person.title || 'Biblical Figure';
        
        let lifespanText = '';
        if (person.birth_year && person.birth_year !== 'Unknown') {
            lifespanText = person.birth_year;
        }
        if (person.death_year && person.death_year !== 'Unknown') {
            lifespanText += ` - ${person.death_year}`;
        }
        if (person.age_at_death && person.age_at_death !== 'Unknown') {
            lifespanText += ` (${person.age_at_death})`;
        }
        lifespan.textContent = lifespanText || 'Lifespan unknown';

        // Update personal information
        updatePersonalInfo(person);
        
        // Update family relationships
        updateFamilyRelationships(person, personId);
        
        // Update life events
        updateLifeEvents(person);
        
        // Update GEDCOM technical details
        updateGedcomDetails(person, personId);
        
        // Update genealogy path
        updateGenealogyPath(person, personId);
        
        // Update statistical information
        updateStatisticalInfo(person, personId);
        
        // Update scripture references
        updateScriptureReferences(person);
    }

    function updatePersonalInfo(person) {
        const container = document.getElementById('personal-info-fields');
        container.innerHTML = '';

        const fields = [
            { label: 'Full Name', value: person.name },
            { label: 'Gender', value: determineGender(person) },
            { label: 'Title/Occupation', value: person.title },
            { label: 'Description', value: person.description },
            { label: 'Birth Year', value: person.birth_year },
            { label: 'Death Year', value: person.death_year },
            { label: 'Age at Death', value: person.age_at_death }
        ];

        fields.forEach(field => {
            if (field.value && field.value !== 'Unknown') {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'gedcom-field';
                fieldDiv.innerHTML = `
                    <div class="field-label">${field.label}</div>
                    <div class="field-value">${field.value}</div>
                `;
                container.appendChild(fieldDiv);
            }
        });

        if (container.children.length === 0) {
            container.innerHTML = '<div class="field-value">No personal information available</div>';
        }
    }

    function updateFamilyRelationships(person, personId) {
        const container = document.getElementById('family-relationships');
        container.innerHTML = '';

        const relationships = [];

        // Parents
        if (person.parents && person.parents.length > 0) {
            person.parents.forEach(parentId => {
                const parent = familyData[parentId];
                if (parent) {
                    relationships.push({
                        name: parent.name,
                        type: 'Parent',
                        id: parentId
                    });
                }
            });
        }

        // Spouse
        if (person.spouse) {
            const spouseId = Object.keys(familyData).find(id => familyData[id].name === person.spouse);
            if (spouseId) {
                relationships.push({
                    name: person.spouse,
                    type: 'Spouse',
                    id: spouseId
                });
            }
        }

        // Children
        if (person.children && person.children.length > 0) {
            person.children.forEach(childId => {
                const child = familyData[childId];
                if (child) {
                    relationships.push({
                        name: child.name,
                        type: 'Child',
                        id: childId
                    });
                }
            });
        }

        if (relationships.length > 0) {
            const connectionsDiv = document.createElement('div');
            connectionsDiv.className = 'family-connections';
            
            relationships.forEach(rel => {
                const card = document.createElement('div');
                card.className = 'connection-card';
                card.onclick = () => selectPerson(rel.id);
                card.innerHTML = `
                    <div class="connection-name">${rel.name}</div>
                    <div class="connection-type">${rel.type}</div>
                `;
                connectionsDiv.appendChild(card);
            });
            
            container.appendChild(connectionsDiv);
        } else {
            container.innerHTML = '<div class="field-value">No family relationships recorded</div>';
        }
    }

    function updateLifeEvents(person) {
        const container = document.getElementById('life-events');
        container.innerHTML = '';

        const events = [];

        if (person.birth_year && person.birth_year !== 'Unknown') {
            events.push({
                label: 'Birth',
                value: person.birth_year,
                icon: 'üéÇ'
            });
        }

        if (person.death_year && person.death_year !== 'Unknown') {
            events.push({
                label: 'Death',
                value: person.death_year,
                icon: '‚ö∞Ô∏è'
            });
        }

        if (person.spouse) {
            events.push({
                label: 'Marriage',
                value: `Married to ${person.spouse}`,
                icon: 'üíí'
            });
        }

        if (person.children && person.children.length > 0) {
            events.push({
                label: 'Children',
                value: `${person.children.length} children`,
                icon: 'üë∂'
            });
        }

        if (events.length > 0) {
            events.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'gedcom-field';
                eventDiv.innerHTML = `
                    <div class="field-label">${event.icon} ${event.label}</div>
                    <div class="field-value">${event.value}</div>
                `;
                container.appendChild(eventDiv);
            });
        } else {
            container.innerHTML = '<div class="field-value">No life events recorded</div>';
        }
    }

    function updateGedcomDetails(person, personId) {
        const container = document.getElementById('gedcom-technical');
        container.innerHTML = '';

        const details = [
            { label: 'Person ID', value: personId, icon: 'üÜî' },
            { label: 'Record Type', value: 'GEDCOM Individual', icon: 'üìã' },
            { label: 'Lineage', value: determineLineage(person), icon: 'üå≥' },
            { label: 'Generation', value: getGenerationInfo(person), icon: 'üìä' },
            { label: 'Gender', value: determineGender(person), icon: determineGender(person) === 'female' ? 'üë©' : 'üë®' },
            { label: 'Data Source', value: 'Biblical GEDCOM Database', icon: 'üíæ' }
        ];

        details.forEach(detail => {
            const detailDiv = document.createElement('div');
            detailDiv.className = 'gedcom-field';
            detailDiv.innerHTML = `
                <div class="field-label">${detail.icon} ${detail.label}</div>
                <div class="field-value">${detail.value}</div>
            `;
            container.appendChild(detailDiv);
        });
    }

    function updateScriptureReferences(person) {
        const container = document.getElementById('scripture-references');
        container.innerHTML = '';

        if (person.verses && person.verses.length > 0) {
            person.verses.forEach(verse => {
                const verseDiv = document.createElement('div');
                verseDiv.className = 'verse-reference-item';
                
                // Parse reference for linking
                const refParts = verse.reference.split(' ');
                let book, chapter, verseLink;
                
                if (refParts.length >= 2) {
                    if (refParts[0] in ['1', '2'] && refParts.length >= 3) {
                        book = refParts[0] + ' ' + refParts[1];
                        chapter = refParts[2].split(':')[0];
                    } else {
                        book = refParts[0];
                        chapter = refParts[1].split(':')[0];
                    }
                    verseLink = `/book/${book}/chapter/${chapter}`;
                }
                
                verseDiv.innerHTML = `
                    <div class="verse-ref">
                        ${verseLink ? `<a href="${verseLink}">${verse.reference}</a>` : verse.reference}
                    </div>
                    <div class="verse-text">"${verse.text}"</div>
                `;
                container.appendChild(verseDiv);
            });
        } else {
            container.innerHTML = '<div class="field-value">No scripture references available</div>';
        }
    }

    function updateGenealogyPath(person, personId) {
        const container = document.getElementById('genealogy-path');
        container.innerHTML = '';

        // Build path from Adam to current person
        const path = buildGenealogyPath(personId);
        
        if (path.length > 0) {
            const pathDiv = document.createElement('div');
            pathDiv.className = 'genealogy-path-display';
            pathDiv.style.cssText = `
                padding: 1rem;
                background: var(--card-background);
                border-radius: 6px;
                border: 1px solid var(--border-color);
                font-family: 'Crimson Text', serif;
                line-height: 2;
            `;
            
            const pathText = path.map((ancestor, index) => {
                return `<span style="color: var(--primary-color); font-weight: 600;">${ancestor.name}</span>`;
            }).join(' ‚Üí ');
            
            pathDiv.innerHTML = `
                <div class="field-label" style="margin-bottom: 0.5rem;">üìç Lineage from Adam</div>
                <div>${pathText}</div>
                <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                    ${path.length} generations from Adam
                </div>
            `;
            container.appendChild(pathDiv);
        } else {
            container.innerHTML = '<div class="field-value">Genealogy path not available</div>';
        }
    }

    function updateStatisticalInfo(person, personId) {
        const container = document.getElementById('statistical-info');
        container.innerHTML = '';

        const stats = [];

        // Count descendants
        const descendantCount = countDescendants(personId);
        stats.push({ label: 'Total Descendants', value: descendantCount, icon: 'üë∂' });

        // Count ancestors
        const ancestorCount = countAncestors(personId);
        stats.push({ label: 'Known Ancestors', value: ancestorCount, icon: 'üë¥' });

        // Siblings count
        const siblingCount = countSiblings(person);
        stats.push({ label: 'Siblings', value: siblingCount, icon: 'üë´' });

        // Children count
        const childrenCount = person.children ? person.children.length : 0;
        stats.push({ label: 'Children', value: childrenCount, icon: 'üë∂' });

        stats.forEach(stat => {
            const statDiv = document.createElement('div');
            statDiv.className = 'gedcom-field';
            statDiv.innerHTML = `
                <div class="field-label">${stat.icon} ${stat.label}</div>
                <div class="field-value">${stat.value}</div>
            `;
            container.appendChild(statDiv);
        });
    }

    function buildGenealogyPath(personId, visited = new Set()) {
        if (visited.has(personId)) return [];
        visited.add(personId);

        const person = familyData[personId];
        if (!person) return [];

        // If this is Adam, start the path
        if (person.name.toLowerCase() === 'adam') {
            return [{ id: personId, name: person.name }];
        }

        // Try to find path through parents
        if (person.parents && person.parents.length > 0) {
            for (const parentId of person.parents) {
                const parentPath = buildGenealogyPath(parentId, visited);
                if (parentPath.length > 0) {
                    return [...parentPath, { id: personId, name: person.name }];
                }
            }
        }

        return [];
    }

    function countDescendants(personId, visited = new Set()) {
        if (visited.has(personId)) return 0;
        visited.add(personId);

        const person = familyData[personId];
        if (!person || !person.children) return 0;

        let count = person.children.length;
        person.children.forEach(childId => {
            count += countDescendants(childId, visited);
        });

        return count;
    }

    function countAncestors(personId, visited = new Set()) {
        if (visited.has(personId)) return 0;
        visited.add(personId);

        const person = familyData[personId];
        if (!person || !person.parents) return 0;

        let count = person.parents.length;
        person.parents.forEach(parentId => {
            count += countAncestors(parentId, visited);
        });

        return count;
    }

    function countSiblings(person) {
        if (!person.parents || person.parents.length === 0) return 0;

        let siblings = new Set();
        person.parents.forEach(parentId => {
            const parent = familyData[parentId];
            if (parent && parent.children) {
                parent.children.forEach(childId => {
                    if (childId !== person.id) {
                        siblings.add(childId);
                    }
                });
            }
        });

        return siblings.size;
    }

    function showParents(person) {
        const parentsSection = document.getElementById('parents-section');
        const parentsGrid = document.getElementById('parents-grid');

        if (person.parents && person.parents.length > 0) {
            parentsSection.style.display = 'block';
            parentsGrid.innerHTML = '';

            person.parents.forEach(parentId => {
                const parent = familyData[parentId];
                if (parent) {
                    const card = createFamilyCard(parent, parentId, 'Parent');
                    parentsGrid.appendChild(card);
                }
            });
        } else {
            parentsSection.style.display = 'none';
        }
    }

    function showSpouse(person) {
        const spouseSection = document.getElementById('spouse-section');
        const spouseGrid = document.getElementById('spouse-grid');

        if (person.spouse) {
            spouseSection.style.display = 'block';
            spouseGrid.innerHTML = '';

            // Find spouse by name
            const spouseId = Object.keys(familyData).find(id =>
                familyData[id].name === person.spouse
            );

            if (spouseId) {
                const spouse = familyData[spouseId];
                const card = createFamilyCard(spouse, spouseId, 'Spouse');
                spouseGrid.appendChild(card);
            }
        } else {
            spouseSection.style.display = 'none';
        }
    }

    function showChildren(person) {
        const childrenSection = document.getElementById('children-section');
        const childrenGrid = document.getElementById('children-grid');

        if (person.children && person.children.length > 0) {
            childrenSection.style.display = 'block';
            childrenGrid.innerHTML = '';

            person.children.forEach(childId => {
                const child = familyData[childId];
                if (child) {
                    const card = createFamilyCard(child, childId, 'Child');
                    childrenGrid.appendChild(card);
                }
            });
        } else {
            childrenSection.style.display = 'none';
        }
    }

    function createFamilyCard(person, personId, relationship) {
        const card = document.createElement('div');
        card.className = 'family-card';
        card.onclick = () => selectPerson(personId);

        let datesText = '';
        if (person.birth_year !== 'Unknown' || person.death_year !== 'Unknown') {
            datesText = `${person.birth_year} - ${person.death_year}`;
        }

        card.innerHTML = `
            <h4>${person.name}</h4>
            <div class="relationship">${relationship}</div>
            <div class="dates">${datesText}</div>
        `;

        return card;
    }

    function showVerses(person) {
        const versesSection = document.getElementById('verses-section');
        const versesList = document.getElementById('verses-list');

        if (person.verses && person.verses.length > 0) {
            versesSection.style.display = 'block';
            versesList.innerHTML = '';

            person.verses.forEach(verse => {
                const verseItem = document.createElement('div');
                verseItem.className = 'verse-item';

                const bookChapter = verse.reference.split(' ');
                const book = bookChapter[0];
                const chapter = bookChapter[1] ? bookChapter[1].split(':')[0] : '';

                verseItem.innerHTML = `
                    <div class="verse-reference">
                        <a href="/book/${book}${chapter ? '/chapter/' + chapter : ''}">${verse.reference}</a>
                    </div>
                    <div class="verse-text">${verse.text}</div>
                `;

                versesList.appendChild(verseItem);
            });
        } else {
            versesSection.style.display = 'none';
        }
    }

    function filterPersons() {
        populatePersonList();
    }

    function filterByLineage(lineage) {
        currentFilter = lineage;

        // Update active filter button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        populatePersonList();
    }

    function showDetailsView() {
        document.getElementById('person-details').classList.remove('details-view');
        document.getElementById('person-details').style.display = 'block';
        document.getElementById('tree-view').style.display = 'none';

        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('button[onclick="showDetailsView()"]').classList.add('active');
    }

    function showTreeView() {
        document.getElementById('person-details').classList.add('details-view');
        document.getElementById('person-details').style.display = 'none';
        document.getElementById('tree-view').style.display = 'block';

        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('button[onclick="showTreeView()"]').classList.add('active');

        // Show layout selector
        document.getElementById('layout-selector').style.display = 'flex';

        // Update D3 tree when switching to tree view
        if (currentPersonId) {
            updateD3Tree(familyData[currentPersonId], currentPersonId);
        }
    }

    // Enhanced Layout Functions
    let currentLayout = 'hierarchical';
    let searchResults = [];
    let analyticsData = {};

    function switchLayout(layoutType) {
        // Update button states
        document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        currentLayout = layoutType;
        
        if (!currentPersonId) return;
        
        const svg = d3.select("#tree-svg");
        svg.selectAll("*").remove();
        
        switch(layoutType) {
            case 'hierarchical':
                updateD3Tree(familyData[currentPersonId], currentPersonId);
                break;
            case 'radial':
                renderRadialLayout(currentPersonId);
                break;
            case 'force-directed':
                renderForceDirectedLayout(currentPersonId);
                break;
            case 'timeline':
                renderTimelineLayout(currentPersonId);
                break;
        }
    }

    function renderRadialLayout(personId) {
        const svg = d3.select("#tree-svg");
        const width = +svg.node().getBoundingClientRect().width;
        const height = +svg.node().getBoundingClientRect().height;
        const centerX = width / 2;
        const centerY = height / 2;
        const maxRadius = Math.min(width, height) / 2 - 60;

        const g = svg.append("g");
        
        // Build radial data
        const radialData = buildRadialData(personId, 3);
        
        // Position nodes in circles
        radialData.forEach((generation, genIndex) => {
            const radius = (genIndex + 1) * (maxRadius / 4);
            const angleStep = (2 * Math.PI) / Math.max(generation.length, 1);
            
            generation.forEach((person, nodeIndex) => {
                const angle = nodeIndex * angleStep - Math.PI / 2;
                person.x = centerX + radius * Math.cos(angle);
                person.y = centerY + radius * Math.sin(angle);
            });
        });

        // Draw connections
        const allNodes = radialData.flat();
        const connections = [];
        
        allNodes.forEach(node => {
            if (node.children) {
                node.children.forEach(childId => {
                    const child = allNodes.find(n => n.id === childId);
                    if (child) {
                        connections.push({ source: node, target: child });
                    }
                });
            }
        });

        g.selectAll('.radial-link')
            .data(connections)
            .enter()
            .append('path')
            .attr('class', 'radial-link')
            .attr('d', d => {
                const midX = (d.source.x + d.target.x) / 2;
                const midY = (d.source.y + d.target.y) / 2;
                return `M${d.source.x},${d.source.y} Q${midX},${midY} ${d.target.x},${d.target.y}`;
            });

        // Draw nodes
        const nodes = g.selectAll('.radial-node')
            .data(allNodes)
            .enter()
            .append('g')
            .attr('class', 'radial-node')
            .attr('transform', d => `translate(${d.x},${d.y})`)
            .on('click', (event, d) => selectPerson(d.id));

        nodes.append('circle')
            .attr('r', d => d.id === personId ? 10 : 6)
            .attr('fill', d => d.id === personId ? '#007bff' : '#6c757d');

        nodes.append('text')
            .attr('dy', -15)
            .attr('text-anchor', 'middle')
            .attr('font-size', '10px')
            .text(d => d.name);
    }

    function renderForceDirectedLayout(personId) {
        const svg = d3.select("#tree-svg");
        const width = +svg.node().getBoundingClientRect().width;
        const height = +svg.node().getBoundingClientRect().height;

        const g = svg.append("g");
        
        const { nodes, links } = buildForceData(personId);

        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(80))
            .force("charge", d3.forceManyBody().strength(-200))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const link = g.selectAll('.force-link')
            .data(links)
            .enter()
            .append('line')
            .attr('class', d => `force-link ${d.type}`)
            .attr('stroke-width', d => d.type === 'marriage' ? 3 : 2);

        const node = g.selectAll('.force-node')
            .data(nodes)
            .enter()
            .append('g')
            .attr('class', 'force-node')
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .on('click', (event, d) => selectPerson(d.id));

        node.append('circle')
            .attr('r', d => d.id === personId ? 12 : 8)
            .attr('fill', d => d.id === personId ? '#007bff' : '#6c757d');

        node.append('text')
            .attr('dy', '.35em')
            .attr('text-anchor', 'middle')
            .style('font-size', '10px')
            .text(d => d.name.length > 10 ? d.name.substring(0, 10) + '...' : d.name);

        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }

    function renderTimelineLayout(personId) {
        const svg = d3.select("#tree-svg");
        const width = +svg.node().getBoundingClientRect().width;
        const height = +svg.node().getBoundingClientRect().height;

        const g = svg.append("g");
        
        // Get timeline data
        const timelineData = Object.values(familyData)
            .filter(person => person.birth_year && person.birth_year !== "Unknown")
            .map(person => ({
                ...person,
                id: Object.keys(familyData).find(id => familyData[id] === person),
                birthYear: parseInt(person.birth_year.match(/\d+/)?.[0] || 0)
            }))
            .sort((a, b) => b.birthYear - a.birthYear);

        if (timelineData.length === 0) {
            g.append('text')
                .attr('x', width / 2)
                .attr('y', height / 2)
                .attr('text-anchor', 'middle')
                .text('No timeline data available');
            return;
        }

        const xScale = d3.scaleLinear()
            .domain(d3.extent(timelineData, d => d.birthYear))
            .range([50, width - 50]);

        const yScale = d3.scaleBand()
            .domain(timelineData.map((d, i) => i))
            .range([50, height - 50])
            .paddingInner(0.1);

        // Draw timeline axis
        g.append('line')
            .attr('x1', 50)
            .attr('y1', height / 2)
            .attr('x2', width - 50)
            .attr('y2', height / 2)
            .attr('stroke', '#333')
            .attr('stroke-width', 2);

        // Draw nodes
        const nodes = g.selectAll('.timeline-node')
            .data(timelineData.slice(0, 15)) // Limit for visibility
            .enter()
            .append('g')
            .attr('class', 'timeline-node')
            .attr('transform', (d, i) => `translate(${xScale(d.birthYear)}, ${yScale(i)})`)
            .on('click', (event, d) => selectPerson(d.id));

        nodes.append('circle')
            .attr('r', d => d.id === personId ? 8 : 5)
            .attr('fill', d => d.id === personId ? '#007bff' : '#6c757d');

        nodes.append('text')
            .attr('dy', -10)
            .attr('text-anchor', 'middle')
            .attr('font-size', '10px')
            .text(d => d.name);

        nodes.append('text')
            .attr('dy', 20)
            .attr('text-anchor', 'middle')
            .attr('font-size', '8px')
            .attr('fill', '#666')
            .text(d => d.birth_year);
    }

    // Helper functions for layouts
    function buildRadialData(rootId, maxGenerations) {
        const generations = [];
        const visited = new Set();
        
        function traverse(personId, generation) {
            if (generation >= maxGenerations || visited.has(personId)) return;
            visited.add(personId);
            
            const person = familyData[personId];
            if (!person) return;
            
            if (!generations[generation]) generations[generation] = [];
            generations[generation].push({
                id: personId,
                name: person.name,
                children: person.children || []
            });
            
            if (person.children) {
                person.children.forEach(childId => traverse(childId, generation + 1));
            }
        }
        
        traverse(rootId, 0);
        return generations.filter(gen => gen && gen.length > 0);
    }

    function buildForceData(rootId) {
        const nodes = [];
        const links = [];
        const visited = new Set();
        
        function traverse(personId, depth = 0) {
            if (depth > 2 || visited.has(personId)) return;
            visited.add(personId);
            
            const person = familyData[personId];
            if (!person) return;
            
            nodes.push({
                id: personId,
                name: person.name,
                group: depth
            });
            
            if (person.children) {
                person.children.forEach(childId => {
                    traverse(childId, depth + 1);
                    links.push({
                        source: personId,
                        target: childId,
                        type: 'parent-child'
                    });
                });
            }
            
            if (person.spouse && !visited.has(person.spouse)) {
                const spouseId = Object.keys(familyData).find(id => familyData[id].name === person.spouse);
                if (spouseId) {
                    traverse(spouseId, depth);
                    links.push({
                        source: personId,
                        target: spouseId,
                        type: 'marriage'
                    });
                }
            }
        }
        
        traverse(rootId);
        return { nodes, links };
    }

    // Enhanced Search Functions
    function toggleSearch() {
        const panel = document.getElementById('search-panel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            calculateSearchIndex();
        } else {
            panel.style.display = 'none';
        }
    }

    function calculateSearchIndex() {
        searchResults = Object.entries(familyData).map(([id, person]) => ({
            id,
            name: person.name.toLowerCase(),
            title: (person.title || '').toLowerCase(),
            description: (person.description || '').toLowerCase(),
            searchText: [person.name, person.title || '', person.description || ''].join(' ').toLowerCase()
        }));
    }

    function performEnhancedSearch() {
        const query = document.getElementById('enhanced-search-input').value.toLowerCase();
        if (!query.trim()) return;
        
        const searchNames = document.getElementById('search-names').checked;
        const searchTitles = document.getElementById('search-titles').checked;
        const searchDescriptions = document.getElementById('search-descriptions').checked;
        
        const results = searchResults.filter(person => {
            let match = false;
            if (searchNames && person.name.includes(query)) match = true;
            if (searchTitles && person.title.includes(query)) match = true;
            if (searchDescriptions && person.description.includes(query)) match = true;
            return match;
        });
        
        displaySearchResults(results);
        highlightSearchResults(results);
    }

    function displaySearchResults(results) {
        const container = document.getElementById('search-results');
        if (results.length === 0) {
            container.innerHTML = '<div style="padding: 10px; color: #666; text-align: center;">No results found</div>';
            return;
        }
        
        container.innerHTML = results.map(result => {
            const person = familyData[result.id];
            return `
                <div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;" onclick="selectPerson('${result.id}')">
                    <div style="font-weight: bold; color: #007bff;">${person.name}</div>
                    <div style="font-size: 12px; color: #666;">${person.title || 'Biblical Figure'}</div>
                </div>
            `;
        }).join('');
    }

    function highlightSearchResults(results) {
        // Clear previous highlights
        d3.selectAll('.tree-node').classed('search-highlight', false);
        
        // Highlight new results
        results.forEach(result => {
            d3.selectAll('.tree-node').filter(d => d && d.data && d.data.id === result.id)
                .classed('search-highlight', true);
        });
    }

    // Analytics Functions
    function toggleAnalytics() {
        const panel = document.getElementById('analytics-panel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            calculateAnalytics();
            renderAnalyticsChart();
        } else {
            panel.style.display = 'none';
        }
    }

    function calculateAnalytics() {
        const total = Object.keys(familyData).length;
        let maleCount = 0;
        let femaleCount = 0;
        const generations = new Set();
        
        Object.values(familyData).forEach(person => {
            // Simple gender detection
            const name = person.name.toLowerCase();
            const femaleNames = ['eve', 'sarah', 'rebekah', 'rachel', 'leah', 'mary', 'elizabeth'];
            if (femaleNames.some(fname => name.includes(fname))) {
                femaleCount++;
            } else {
                maleCount++;
            }
            
            // Estimate generation (simplified)
            if (person.parents && person.parents.length > 0) {
                generations.add(person.parents.length);
            }
        });
        
        document.getElementById('total-persons').textContent = total;
        document.getElementById('male-count').textContent = maleCount;
        document.getElementById('female-count').textContent = femaleCount;
        document.getElementById('generations-count').textContent = Math.max(5, generations.size);
        
        analyticsData = { total, maleCount, femaleCount, generations: generations.size };
    }

    function renderAnalyticsChart() {
        const ctx = document.getElementById('demo-chart');
        if (!ctx || typeof Chart === 'undefined') return;
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Male', 'Female'],
                datasets: [{
                    data: [analyticsData.maleCount, analyticsData.femaleCount],
                    backgroundColor: ['#2196F3', '#E91E63'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Gender Distribution'
                    }
                }
            }
        });
    }

    function exportTree() {
        const svg = document.getElementById('tree-svg');
        const svgData = new XMLSerializer().serializeToString(svg);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            const link = document.createElement('a');
            link.download = `family-tree-${new Date().getTime()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        };
        
        img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
    }

    let treeData = null;
    let svg = null;
    let g = null;
    let tree = null;
    let zoom = null;

    function initializeD3Tree() {
        svg = d3.select("#tree-svg");
        const width = +svg.node().getBoundingClientRect().width;
        const height = +svg.node().getBoundingClientRect().height;

        zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        g = svg.append("g");

        tree = d3.tree().size([height - 100, width - 200]);
    }

    function determineGender(person) {
        const name = person.name.toLowerCase();
        
        // Known biblical female names (expanded list)
        const femaleNames = [
            'eve', 'sarah', 'sarai', 'rebekah', 'rebecca', 'rachel', 'leah', 'dinah', 
            'tamar', 'miriam', 'deborah', 'ruth', 'naomi', 'bathsheba', 'bath-sheba',
            'abigail', 'esther', 'judith', 'mary', 'elizabeth', 'anna', 'hannah',
            'martha', 'mary magdalene', 'dorcas', 'lydia', 'priscilla', 'prisca',
            'naamah', 'adah', 'zillah', 'milcah', 'iscah', 'hagar', 'keturah',
            'asenath', 'potipherah', 'zipporah', 'gomer', 'rizpah', 'maacah',
            'haggith', 'abital', 'eglah', 'michal', 'ahinoam', 'abigail',
            'jezebel', 'athaliah', 'huldah', 'vashti', 'zeresh', 'peninnah',
            'orpah', 'ruth', 'nomi', 'mara', 'rahab', 'jael', 'sisera',
            'gideon', 'samson', 'delilah', 'hannah', 'abigail', 'bathsheba'
        ];
        
        // Remove duplicates and clean up the list
        const uniqueFemaleNames = [...new Set(femaleNames)].filter(n => n && n.length > 0);
        
        // Check if it's a known female name
        if (uniqueFemaleNames.includes(name)) {
            return 'female';
        }
        
        // Check for name endings that suggest female names
        if (name.endsWith('ah') || name.endsWith('iah') || name.endsWith('beth') || name.endsWith('anna')) {
            // But exclude male names that also end this way
            const maleExceptions = ['noah', 'judah', 'micah', 'hosea', 'nehemiah', 'jeremiah', 'isaiah', 'obadiah'];
            if (!maleExceptions.includes(name)) {
                return 'female';
            }
        }
        
        // If person has a spouse, try to determine from relationship context
        if (person.spouse) {
            // Look for contextual clues in description or title
            const description = (person.description || '').toLowerCase();
            const title = (person.title || '').toLowerCase();
            
            if (description.includes('wife') || title.includes('wife') || 
                description.includes('mother') || title.includes('mother') ||
                description.includes('daughter') || title.includes('daughter')) {
                return 'female';
            }
            if (description.includes('husband') || title.includes('husband') ||
                description.includes('father') || title.includes('father') ||
                description.includes('son') || title.includes('son')) {
                return 'male';
            }
        }
        
        // Default to male for biblical genealogies (most recorded names are male)
        return 'male';
    }

    function buildTreeData(rootPersonId, maxDepth = 3) {
        const visited = new Set();

        function buildNode(personId, depth = 0) {
            if (!personId || visited.has(personId) || depth > maxDepth) return null;

            visited.add(personId);
            const person = familyData[personId];
            if (!person) return null;

            const node = {
                id: personId,
                name: person.name,
                data: person,
                gender: determineGender(person),
                children: [],
                spouse: null
            };

            // Add spouse
            if (person.spouse) {
                const spouseId = Object.keys(familyData).find(id => familyData[id].name === person.spouse);
                if (spouseId && !visited.has(spouseId)) {
                    const spouseData = familyData[spouseId];
                    node.spouse = {
                        id: spouseId,
                        name: person.spouse,
                        data: spouseData,
                        gender: determineGender(spouseData)
                    };
                }
            }

            // Add children
            if (person.children && depth < maxDepth) {
                person.children.forEach(childId => {
                    const childNode = buildNode(childId, depth + 1);
                    if (childNode) {
                        node.children.push(childNode);
                    }
                });
            }

            // Add parents if we're at root and depth allows
            if (depth === 0 && person.parents) {
                person.parents.forEach(parentId => {
                    const parentNode = buildNode(parentId, -1);
                    if (parentNode) {
                        // Parents are added as reverse children for upward tree
                        parentNode.children = [node];
                        return parentNode;
                    }
                });
            }

            return node;
        }

        return buildNode(rootPersonId);
    }

    function updateD3Tree(person, personId) {
        if (!svg) initializeD3Tree();

        treeData = buildTreeData(personId);
        if (!treeData) return;

        const root = d3.hierarchy(treeData);
        const treeLayout = tree(root);

        // Clear previous tree
        g.selectAll("*").remove();

        // Draw links
        const links = g.selectAll('.tree-link')
            .data(treeLayout.links())
            .enter()
            .append('path')
            .attr('class', 'tree-link')
            .attr('d', d3.linkHorizontal()
                .x(d => d.y)
                .y(d => d.x));

        // Draw spouse links
        const spouseLinks = g.selectAll('.spouse-link')
            .data(treeLayout.descendants().filter(d => d.data.spouse))
            .enter()
            .append('line')
            .attr('class', 'tree-link marriage')
            .attr('x1', d => d.y)
            .attr('y1', d => d.x)
            .attr('x2', d => d.y + 50)
            .attr('y2', d => d.x);
        
        // Draw nodes
        const nodes = g.selectAll('.tree-node')
            .data(treeLayout.descendants())
            .enter()
            .append('g')
            .attr('class', d => `tree-node ${d.data.gender} ${d.data.id === personId ? 'current' : ''}`)
            .attr('transform', d => `translate(${d.y},${d.x})`)
            .on('click', (event, d) => {
                selectPerson(d.data.id);
            });
        
        nodes.append('circle')
            .attr('r', 6);
        
        nodes.append('text')
            .attr('dy', '.35em')
            .attr('x', d => d.children ? -13 : 13)
            .style('text-anchor', d => d.children ? 'end' : 'start')
            .text(d => d.data.name);
        
        // Draw spouse nodes
        const spouseNodes = g.selectAll('.spouse-node')
            .data(treeLayout.descendants().filter(d => d.data.spouse))
            .enter()
            .append('g')
            .attr('class', d => `tree-node spouse ${d.data.spouse.gender}`)
            .attr('transform', d => `translate(${d.y + 50},${d.x})`)
            .on('click', (event, d) => {
                selectPerson(d.data.spouse.id);
            });
        
        spouseNodes.append('circle')
            .attr('r', 6);
        
        spouseNodes.append('text')
            .attr('dy', '.35em')
            .attr('x', 13)
            .style('text-anchor', 'start')
            .text(d => d.data.spouse.name);
        
        // Center the tree
        centerTree();
    }

    function centerTree() {
        if (!svg || !g) return;
        
        const bounds = g.node().getBBox();
        const parent = svg.node().getBoundingClientRect();
        const fullWidth = parent.width;
        const fullHeight = parent.height;
        const width = bounds.width;
        const height = bounds.height;
        const midX = bounds.x + width / 2;
        const midY = bounds.y + height / 2;
        
        const scale = 0.8 / Math.max(width / fullWidth, height / fullHeight);
        const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];
        
        svg.transition()
            .duration(750)
            .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
    }

    function expandAll() {
        // Implementation for expanding all nodes
        if (currentPersonId) {
            updateD3Tree(familyData[currentPersonId], currentPersonId);
        }
    }

    function collapseAll() {
        // Implementation for collapsing nodes
        if (currentPersonId) {
            treeData = buildTreeData(currentPersonId, 1);
            updateD3Tree(familyData[currentPersonId], currentPersonId);
        }
    }
</script>
{% endblock %}
