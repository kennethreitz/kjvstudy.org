{% extends "base.html" %}
{% block title %}Biblical Family Tree Explorer - KJV Study{% endblock %}
{% block description %}Explore biblical genealogies with an interactive person index and family tree viewer. Browse from Adam to the patriarchs with detailed family relationships.{% endblock %}
{% block keywords %}biblical family tree, biblical genealogy, Adam and Eve, patriarchs, biblical lineage, Old Testament families, KJV genealogy{% endblock %}
{% block og_title %}Biblical Family Tree Explorer - KJV Study{% endblock %}

{% block head %}
<!-- D3.js Library -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
    .family-explorer-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
    }

    .family-explorer-header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem 1rem;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 12px;
        color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .family-explorer-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        font-family: "Crimson Text", serif;
    }

    .family-explorer-header p {
        font-size: 1.1rem;
        opacity: 0.9;
        max-width: 700px;
        margin: 0 auto;
    }

    .explorer-layout {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    .person-index {
        background: var(--card-background);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        height: fit-content;
        max-height: 80vh;
        overflow-y: auto;
    }

    .index-header {
        margin-bottom: 1.5rem;
    }

    .index-header h2 {
        color: var(--primary-color);
        font-family: "Crimson Text", serif;
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }

    .search-box {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
        background: var(--background-color);
        color: var(--text-color);
        margin-bottom: 1rem;
    }

    .search-box:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(75, 46, 131, 0.1);
    }

    .filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .filter-btn {
        padding: 0.4rem 0.8rem;
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.2s ease;
    }

    .filter-btn:hover,
    .filter-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .person-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .person-item {
        padding: 0.75rem;
        cursor: pointer;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .person-item:hover {
        background: var(--hover-background);
        border-color: var(--border-color);
    }

    .person-item.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .person-name {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }

    .person-title {
        font-size: 0.8rem;
        opacity: 0.8;
        margin-bottom: 0.25rem;
    }

    .person-generation {
        font-size: 0.7rem;
        opacity: 0.6;
    }

    .family-viewer {
        background: var(--card-background);
        border-radius: 12px;
        padding: 2rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        min-height: 80vh;
    }

    .view-toggle {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        gap: 0.5rem;
    }

    .view-btn {
        padding: 0.5rem 1rem;
        border: 2px solid var(--primary-color);
        background: transparent;
        color: var(--primary-color);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .view-btn.active {
        background: var(--primary-color);
        color: white;
    }

    .view-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    .tree-view {
        display: block;
        margin-top: 2rem;
    }

    .details-view {
        display: none;
    }

    .d3-tree-container {
        width: 100%;
        height: 600px;
        background: var(--background-color);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        position: relative;
    }

    .d3-tree-svg {
        width: 100%;
        height: 100%;
    }

    .tree-node {
        cursor: pointer;
    }

    .tree-node circle {
        fill: #2d3436;
        stroke: #ffc107;
        stroke-width: 3px;
        transition: all 0.3s ease;
    }

    .tree-node.current circle {
        fill: #ffc107;
        stroke: #ffc107;
        stroke-width: 4px;
    }

    .tree-node.male circle {
        fill: #2d3436;
        stroke: #74b9ff;
        stroke-width: 3px;
    }

    .tree-node.female circle {
        fill: #2d3436;
        stroke: #fd79a8;
        stroke-width: 3px;
    }

    .tree-node.current.male circle {
        fill: #74b9ff;
        stroke: #74b9ff;
        stroke-width: 4px;
    }

    .tree-node.current.female circle {
        fill: #fd79a8;
        stroke: #fd79a8;
        stroke-width: 4px;
    }

    .tree-node.spouse circle {
        fill: #2d3436;
        stroke: #28a745;
    }

    .tree-node.parent circle {
        fill: #2d3436;
        stroke: #74b9ff;
    }

    .tree-node.child circle {
        fill: #2d3436;
        stroke: #fd79a8;
    }

    .tree-node:hover circle {
        r: 8;
        stroke-width: 4px;
    }

    .tree-node text {
        font: 12px sans-serif;
        fill: #f8f9fa;
        text-anchor: middle;
        dominant-baseline: central;
        pointer-events: none;
    }

    .tree-node.current text {
        fill: #2d3436;
        font-weight: bold;
    }

    .tree-node.current.male text {
        fill: white;
        font-weight: bold;
    }

    .tree-node.current.female text {
        fill: white;
        font-weight: bold;
    }

    .tree-link {
        fill: none;
        stroke: #636e72;
        stroke-width: 2px;
    }

    .tree-link.marriage {
        stroke: #00b894;
        stroke-width: 3px;
        stroke-dasharray: 5,5;
    }

    .tree-controls {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: #2d3436;
        border: 1px solid #636e72;
        border-radius: 8px;
        padding: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .gender-legend {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: #2d3436;
        border: 1px solid #636e72;
        border-radius: 8px;
        padding: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        font-size: 0.8rem;
        color: #f8f9fa;
    }

    .legend-title {
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #ffc107;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .legend-item:last-child {
        margin-bottom: 0;
    }

    .legend-circle {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid;
    }

    .legend-circle.male {
        background: #2d3436;
        border-color: #74b9ff;
    }

    .legend-circle.female {
        background: #2d3436;
        border-color: #fd79a8;
    }

    .legend-circle.current {
        background: #ffc107;
        border-color: #ffc107;
    }

    .tree-controls button {
        margin: 0.25rem;
        padding: 0.25rem 0.5rem;
        border: 1px solid #636e72;
        background: #2d3436;
        color: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .tree-controls button:hover {
        background: #ffc107;
        color: #2d3436;
        border-color: #ffc107;
    }

    @media (max-width: 768px) {
        .d3-tree-container {
            height: 400px;
        }

        .tree-node text {
            font-size: 10px;
        }

        .tree-controls {
            padding: 0.25rem;
        }

        .tree-controls button {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }

        .gender-legend {
            font-size: 0.7rem;
            padding: 0.5rem;
        }
    }

    .welcome-message {
        text-align: center;
        color: var(--text-muted);
        padding: 4rem 2rem;
    }

    .welcome-message h3 {
        color: var(--primary-color);
        font-family: "Crimson Text", serif;
        margin-bottom: 1rem;
    }

    .current-person {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: var(--background-color);
        border-radius: 8px;
        border: 2px solid var(--primary-color);
    }

    .current-person h2 {
        font-size: 2rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        font-family: "Crimson Text", serif;
    }

    .current-person .title {
        font-size: 1.2rem;
        color: var(--text-muted);
        font-style: italic;
        margin-bottom: 1rem;
    }

    .current-person .dates {
        font-size: 1rem;
        color: var(--text-color);
        margin-bottom: 1rem;
    }

    .current-person .description {
        font-style: italic;
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
    }

    .family-section {
        margin-bottom: 2rem;
    }

    .family-section h3 {
        font-size: 1.3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-family: "Crimson Text", serif;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.5rem;
    }

    .family-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .family-card {
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }

    .family-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }

    .family-card h4 {
        font-size: 1.1rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        font-family: "Crimson Text", serif;
    }

    .family-card .relationship {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    .family-card .dates {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .verses-section {
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--background-color);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .verses-section h3 {
        color: var(--primary-color);
        margin-bottom: 1rem;
        font-family: "Crimson Text", serif;
    }

    .verse-item {
        background: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
    }

    .verse-item:hover {
        background: var(--hover-background);
        border-color: var(--primary-color);
    }

    .verse-reference {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        font-family: "Inter", sans-serif;
    }

    .verse-reference a {
        color: inherit;
        text-decoration: none;
    }

    .verse-reference a:hover {
        text-decoration: underline;
    }

    .verse-text {
        font-family: "Crimson Text", serif;
        font-size: 1rem;
        line-height: 1.6;
        color: var(--text-color);
        font-style: italic;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--background-color);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        text-align: center;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
        font-family: "Crimson Text", serif;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    @media (max-width: 1024px) {
        .explorer-layout {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .person-index {
            max-height: 40vh;
            order: 2;
        }

        .family-viewer {
            order: 1;
            min-height: auto;
        }
    }

    @media (max-width: 768px) {
        .family-explorer-header h1 {
            font-size: 2rem;
        }

        .explorer-layout {
            grid-template-columns: 1fr;
        }

        .person-index {
            max-height: 50vh;
        }

        .family-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Dark mode adjustments */
    @media (prefers-color-scheme: dark) {
        .family-explorer-header {
            background: linear-gradient(135deg, #2d1b69, #8b5a2b);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="family-explorer-container">
    <header class="family-explorer-header">
        <h1>üå≥ Biblical Family Tree Explorer</h1>
        <p>
            Explore biblical genealogies with an interactive person index.
            Click on any person to see their family relationships and scripture references.
        </p>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="total-persons">0</div>
            <div class="stat-label">Total Persons</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-families">0</div>
            <div class="stat-label">Family Groups</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-generations">0</div>
            <div class="stat-label">Generations</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="selected-generation">-</div>
            <div class="stat-label">Selected Person</div>
        </div>
    </div>

    <div class="explorer-layout">
        <div class="person-index">
            <div class="index-header">
                <h2>üìú Person Index</h2>
                <input
                    type="text"
                    class="search-box"
                    id="person-search"
                    placeholder="Search by name..."
                    onkeyup="filterPersons()"
                >
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByLineage('all')">All</button>
                    <button class="filter-btn" onclick="filterByLineage('seth')">Seth's Line</button>
                    <button class="filter-btn" onclick="filterByLineage('cain')">Cain's Line</button>
                    <button class="filter-btn" onclick="filterByLineage('noah')">Noah's Sons</button>
                </div>
            </div>
            <ul class="person-list" id="person-list">
                <!-- Persons will be populated by JavaScript -->
            </ul>
        </div>

        <div class="family-viewer">
            <div class="welcome-message" id="welcome-message">
                <h3>üëà Select a Person</h3>
                <p>Choose someone from the person index to explore their family relationships and see relevant scripture passages.</p>
                <p>The biblical genealogies contain {{ family_tree_data|length }} individuals spanning many generations from Adam to the patriarchs of Israel.</p>
            </div>

            <div class="view-toggle" id="view-toggle" style="display: flex;">
                <button class="view-btn" onclick="showDetailsView()">üìã Details View</button>
                <button class="view-btn active" onclick="showTreeView()">üå≥ Tree View</button>
            </div>

            <div class="tree-view" id="tree-view">
                <div class="d3-tree-container">
                    <div class="tree-controls">
                        <button onclick="centerTree()">Center</button>
                        <button onclick="expandAll()">Expand All</button>
                        <button onclick="collapseAll()">Collapse All</button>
                    </div>
                    <svg class="d3-tree-svg" id="tree-svg"></svg>
                    
                    <div class="gender-legend">
                        <div class="legend-title">Gender</div>
                        <div class="legend-item">
                            <div class="legend-circle male"></div>
                            <span>Male</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-circle female"></div>
                            <span>Female</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-circle current"></div>
                            <span>Current Person</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="details-view" id="person-details">
                <div class="current-person">
                    <h2 id="current-name"></h2>
                    <div class="title" id="current-title"></div>
                    <div class="dates" id="current-dates"></div>
                    <div class="description" id="current-description"></div>
                </div>

                <div class="family-section" id="parents-section" style="display: none;">
                    <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parents</h3>
                    <div class="family-grid" id="parents-grid"></div>
                </div>

                <div class="family-section" id="spouse-section" style="display: none;">
                    <h3>üíë Spouse</h3>
                    <div class="family-grid" id="spouse-grid"></div>
                </div>

                <div class="family-section" id="children-section" style="display: none;">
                    <h3>üë∂ Children</h3>
                    <div class="family-grid" id="children-grid"></div>
                </div>

                <div class="verses-section" id="verses-section" style="display: none;">
                    <h3>üìñ Scripture References</h3>
                    <div id="verses-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Family tree data passed from the server
    const familyData = {{ family_tree_data | tojson }};
    let currentPersonId = null;
    let currentFilter = 'all';
    let allPersons = [];

    // Initialize the explorer
    document.addEventListener('DOMContentLoaded', function() {
        initializeExplorer();
    });

    function initializeExplorer() {
        // Convert family data to sorted array
        allPersons = Object.keys(familyData).map(id => ({
            id: id,
            ...familyData[id]
        })).sort((a, b) => a.name.localeCompare(b.name));

        // Update statistics
        updateStatistics();

        // Populate person list
        populatePersonList();

        // Select Adam by default if available
        const adamId = Object.keys(familyData).find(id =>
            familyData[id].name.toLowerCase() === 'adam'
        );
        if (adamId) {
            selectPerson(adamId);
        }
    }

    function updateStatistics() {
        document.getElementById('total-persons').textContent = allPersons.length;

        // Count families (people with children)
        const families = allPersons.filter(person => person.children && person.children.length > 0);
        document.getElementById('total-families').textContent = families.length;

        // Estimate generations (this is approximate)
        document.getElementById('total-generations').textContent = '12+';
    }

    function populatePersonList() {
        const personList = document.getElementById('person-list');
        personList.innerHTML = '';

        let filteredPersons = allPersons;

        // Apply search filter
        const searchTerm = document.getElementById('person-search').value.toLowerCase();
        if (searchTerm) {
            filteredPersons = filteredPersons.filter(person =>
                person.name.toLowerCase().includes(searchTerm) ||
                (person.title && person.title.toLowerCase().includes(searchTerm))
            );
        }

        // Apply lineage filter
        if (currentFilter !== 'all') {
            filteredPersons = filteredPersons.filter(person => {
                const lineage = determineLineage(person);
                return lineage === currentFilter;
            });
        }

        filteredPersons.forEach(person => {
            const listItem = document.createElement('li');
            listItem.className = 'person-item';
            if (currentPersonId === person.id) {
                listItem.classList.add('active');
            }

            const lineage = determineLineage(person);
            const generationInfo = getGenerationInfo(person);

            listItem.innerHTML = `
                <div class="person-name">${person.name}</div>
                <div class="person-title">${person.title || 'Biblical Figure'}</div>
                <div class="person-generation">${lineage} ‚Ä¢ ${generationInfo}</div>
            `;

            listItem.onclick = () => selectPerson(person.id);
            personList.appendChild(listItem);
        });

        if (filteredPersons.length === 0) {
            personList.innerHTML = '<li style="padding: 1rem; text-align: center; color: var(--text-muted);">No persons found</li>';
        }
    }

    function determineLineage(person) {
        // Simple lineage determination based on name patterns and known relationships
        const name = person.name.toLowerCase();

        // Known Cain's line
        if (['cain', 'enoch', 'irad', 'mehujael', 'methusael', 'lamech', 'jabal', 'jubal', 'tubalcain', 'naamah'].includes(name)) {
            return 'cain';
        }

        // Known Seth's line (main genealogy)
        if (['seth', 'enos', 'cainan', 'mahalaleel', 'jared', 'enoch', 'methuselah', 'lamech', 'noah'].includes(name)) {
            return 'seth';
        }

        // Noah's sons and their descendants
        if (['shem', 'ham', 'japheth'].includes(name) || person.parents?.some(p => ['shem', 'ham', 'japheth'].includes(familyData[p]?.name?.toLowerCase()))) {
            return 'noah';
        }

        return 'other';
    }

    function getGenerationInfo(person) {
        // Simplified generation calculation
        if (!person.birth_year || person.birth_year === 'Unknown') {
            return 'Generation unknown';
        }

        // Try to extract year from birth_year string
        const yearMatch = person.birth_year.match(/\d+/);
        if (yearMatch) {
            const year = parseInt(yearMatch[0]);
            if (year > 4000) return 'Generation 1-2';
            if (year > 3500) return 'Generation 3-5';
            if (year > 3000) return 'Generation 6-8';
            if (year > 2500) return 'Generation 9-11';
            return 'Later generations';
        }

        return 'Generation unknown';
    }

    function selectPerson(personId) {
        currentPersonId = personId;
        const person = familyData[personId];

        if (!person) return;

        // Update active state in person list
        document.querySelectorAll('.person-item').forEach(item => {
            item.classList.remove('active');
        });

        // Find and activate the current person in the list
        const personItems = document.querySelectorAll('.person-item');
        personItems.forEach(item => {
            if (item.querySelector('.person-name').textContent === person.name) {
                item.classList.add('active');
            }
        });

        // Hide welcome message and show tree view by default
        document.getElementById('welcome-message').style.display = 'none';
        document.getElementById('view-toggle').style.display = 'flex';

        // Show tree view by default
        if (document.getElementById('tree-view').style.display !== 'none') {
            updateD3Tree(person, personId);
        }

        // Update current person info
        document.getElementById('current-name').textContent = person.name;
        document.getElementById('current-title').textContent = person.title || 'Biblical Figure';

        // Update dates
        let datesText = '';
        if (person.birth_year !== 'Unknown' || person.death_year !== 'Unknown') {
            datesText = `${person.birth_year} - ${person.death_year}`;
            if (person.age_at_death !== 'Unknown') {
                datesText += ` (${person.age_at_death})`;
            }
        }
        document.getElementById('current-dates').textContent = datesText;

        document.getElementById('current-description').textContent = person.description;

        // Update selected person generation in stats
        document.getElementById('selected-generation').textContent = getGenerationInfo(person);

        // Show family sections
        showParents(person);
        showSpouse(person);
        showChildren(person);
        showVerses(person);

        // Update D3 tree view
        updateD3Tree(person, personId);
    }

    function showParents(person) {
        const parentsSection = document.getElementById('parents-section');
        const parentsGrid = document.getElementById('parents-grid');

        if (person.parents && person.parents.length > 0) {
            parentsSection.style.display = 'block';
            parentsGrid.innerHTML = '';

            person.parents.forEach(parentId => {
                const parent = familyData[parentId];
                if (parent) {
                    const card = createFamilyCard(parent, parentId, 'Parent');
                    parentsGrid.appendChild(card);
                }
            });
        } else {
            parentsSection.style.display = 'none';
        }
    }

    function showSpouse(person) {
        const spouseSection = document.getElementById('spouse-section');
        const spouseGrid = document.getElementById('spouse-grid');

        if (person.spouse) {
            spouseSection.style.display = 'block';
            spouseGrid.innerHTML = '';

            // Find spouse by name
            const spouseId = Object.keys(familyData).find(id =>
                familyData[id].name === person.spouse
            );

            if (spouseId) {
                const spouse = familyData[spouseId];
                const card = createFamilyCard(spouse, spouseId, 'Spouse');
                spouseGrid.appendChild(card);
            }
        } else {
            spouseSection.style.display = 'none';
        }
    }

    function showChildren(person) {
        const childrenSection = document.getElementById('children-section');
        const childrenGrid = document.getElementById('children-grid');

        if (person.children && person.children.length > 0) {
            childrenSection.style.display = 'block';
            childrenGrid.innerHTML = '';

            person.children.forEach(childId => {
                const child = familyData[childId];
                if (child) {
                    const card = createFamilyCard(child, childId, 'Child');
                    childrenGrid.appendChild(card);
                }
            });
        } else {
            childrenSection.style.display = 'none';
        }
    }

    function createFamilyCard(person, personId, relationship) {
        const card = document.createElement('div');
        card.className = 'family-card';
        card.onclick = () => selectPerson(personId);

        let datesText = '';
        if (person.birth_year !== 'Unknown' || person.death_year !== 'Unknown') {
            datesText = `${person.birth_year} - ${person.death_year}`;
        }

        card.innerHTML = `
            <h4>${person.name}</h4>
            <div class="relationship">${relationship}</div>
            <div class="dates">${datesText}</div>
        `;

        return card;
    }

    function showVerses(person) {
        const versesSection = document.getElementById('verses-section');
        const versesList = document.getElementById('verses-list');

        if (person.verses && person.verses.length > 0) {
            versesSection.style.display = 'block';
            versesList.innerHTML = '';

            person.verses.forEach(verse => {
                const verseItem = document.createElement('div');
                verseItem.className = 'verse-item';

                const bookChapter = verse.reference.split(' ');
                const book = bookChapter[0];
                const chapter = bookChapter[1] ? bookChapter[1].split(':')[0] : '';

                verseItem.innerHTML = `
                    <div class="verse-reference">
                        <a href="/book/${book}${chapter ? '/chapter/' + chapter : ''}">${verse.reference}</a>
                    </div>
                    <div class="verse-text">${verse.text}</div>
                `;

                versesList.appendChild(verseItem);
            });
        } else {
            versesSection.style.display = 'none';
        }
    }

    function filterPersons() {
        populatePersonList();
    }

    function filterByLineage(lineage) {
        currentFilter = lineage;

        // Update active filter button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        populatePersonList();
    }

    function showDetailsView() {
        document.getElementById('person-details').classList.remove('details-view');
        document.getElementById('person-details').style.display = 'block';
        document.getElementById('tree-view').style.display = 'none';

        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('button[onclick="showDetailsView()"]').classList.add('active');
    }

    function showTreeView() {
        document.getElementById('person-details').classList.add('details-view');
        document.getElementById('person-details').style.display = 'none';
        document.getElementById('tree-view').style.display = 'block';

        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('button[onclick="showTreeView()"]').classList.add('active');

        // Update D3 tree when switching to tree view
        if (currentPersonId) {
            updateD3Tree(familyData[currentPersonId], currentPersonId);
        }
    }

    let treeData = null;
    let svg = null;
    let g = null;
    let tree = null;
    let zoom = null;

    function initializeD3Tree() {
        svg = d3.select("#tree-svg");
        const width = +svg.node().getBoundingClientRect().width;
        const height = +svg.node().getBoundingClientRect().height;

        zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        g = svg.append("g");

        tree = d3.tree().size([height - 100, width - 200]);
    }

    function determineGender(person) {
        const name = person.name.toLowerCase();
        
        // Known biblical female names (expanded list)
        const femaleNames = [
            'eve', 'sarah', 'sarai', 'rebekah', 'rebecca', 'rachel', 'leah', 'dinah', 
            'tamar', 'miriam', 'deborah', 'ruth', 'naomi', 'bathsheba', 'bath-sheba',
            'abigail', 'esther', 'judith', 'mary', 'elizabeth', 'anna', 'hannah',
            'martha', 'mary magdalene', 'dorcas', 'lydia', 'priscilla', 'prisca',
            'naamah', 'adah', 'zillah', 'milcah', 'iscah', 'hagar', 'keturah',
            'asenath', 'potipherah', 'zipporah', 'gomer', 'rizpah', 'maacah',
            'haggith', 'abital', 'eglah', 'michal', 'ahinoam', 'abigail',
            'jezebel', 'athaliah', 'huldah', 'vashti', 'zeresh', 'peninnah',
            'orpah', 'ruth', 'nomi', 'mara', 'rahab', 'jael', 'sisera',
            'gideon', 'samson', 'delilah', 'hannah', 'abigail', 'bathsheba'
        ];
        
        // Remove duplicates and clean up the list
        const uniqueFemaleNames = [...new Set(femaleNames)].filter(n => n && n.length > 0);
        
        // Check if it's a known female name
        if (uniqueFemaleNames.includes(name)) {
            return 'female';
        }
        
        // Check for name endings that suggest female names
        if (name.endsWith('ah') || name.endsWith('iah') || name.endsWith('beth') || name.endsWith('anna')) {
            // But exclude male names that also end this way
            const maleExceptions = ['noah', 'judah', 'micah', 'hosea', 'nehemiah', 'jeremiah', 'isaiah', 'obadiah'];
            if (!maleExceptions.includes(name)) {
                return 'female';
            }
        }
        
        // If person has a spouse, try to determine from relationship context
        if (person.spouse) {
            // Look for contextual clues in description or title
            const description = (person.description || '').toLowerCase();
            const title = (person.title || '').toLowerCase();
            
            if (description.includes('wife') || title.includes('wife') || 
                description.includes('mother') || title.includes('mother') ||
                description.includes('daughter') || title.includes('daughter')) {
                return 'female';
            }
            if (description.includes('husband') || title.includes('husband') ||
                description.includes('father') || title.includes('father') ||
                description.includes('son') || title.includes('son')) {
                return 'male';
            }
        }
        
        // Default to male for biblical genealogies (most recorded names are male)
        return 'male';
    }

    function buildTreeData(rootPersonId, maxDepth = 3) {
        const visited = new Set();

        function buildNode(personId, depth = 0) {
            if (!personId || visited.has(personId) || depth > maxDepth) return null;

            visited.add(personId);
            const person = familyData[personId];
            if (!person) return null;

            const node = {
                id: personId,
                name: person.name,
                data: person,
                gender: determineGender(person),
                children: [],
                spouse: null
            };

            // Add spouse
            if (person.spouse) {
                const spouseId = Object.keys(familyData).find(id => familyData[id].name === person.spouse);
                if (spouseId && !visited.has(spouseId)) {
                    const spouseData = familyData[spouseId];
                    node.spouse = {
                        id: spouseId,
                        name: person.spouse,
                        data: spouseData,
                        gender: determineGender(spouseData)
                    };
                }
            }

            // Add children
            if (person.children && depth < maxDepth) {
                person.children.forEach(childId => {
                    const childNode = buildNode(childId, depth + 1);
                    if (childNode) {
                        node.children.push(childNode);
                    }
                });
            }

            // Add parents if we're at root and depth allows
            if (depth === 0 && person.parents) {
                person.parents.forEach(parentId => {
                    const parentNode = buildNode(parentId, -1);
                    if (parentNode) {
                        // Parents are added as reverse children for upward tree
                        parentNode.children = [node];
                        return parentNode;
                    }
                });
            }

            return node;
        }

        return buildNode(rootPersonId);
    }

    function updateD3Tree(person, personId) {
        if (!svg) initializeD3Tree();

        treeData = buildTreeData(personId);
        if (!treeData) return;

        const root = d3.hierarchy(treeData);
        const treeLayout = tree(root);

        // Clear previous tree
        g.selectAll("*").remove();

        // Draw links
        const links = g.selectAll('.tree-link')
            .data(treeLayout.links())
            .enter()
            .append('path')
            .attr('class', 'tree-link')
            .attr('d', d3.linkHorizontal()
                .x(d => d.y)
                .y(d => d.x));

        // Draw spouse links
        const spouseLinks = g.selectAll('.spouse-link')
            .data(treeLayout.descendants().filter(d => d.data.spouse))
            .enter()
            .append('line')
            .attr('class', 'tree-link marriage')
            .attr('x1', d => d.y)
            .attr('y1', d => d.x)
            .attr('x2', d => d.y + 50)
            .attr('y2', d => d.x);
        
        // Draw nodes
        const nodes = g.selectAll('.tree-node')
            .data(treeLayout.descendants())
            .enter()
            .append('g')
            .attr('class', d => `tree-node ${d.data.gender} ${d.data.id === personId ? 'current' : ''}`)
            .attr('transform', d => `translate(${d.y},${d.x})`)
            .on('click', (event, d) => {
                selectPerson(d.data.id);
            });
        
        nodes.append('circle')
            .attr('r', 6);
        
        nodes.append('text')
            .attr('dy', '.35em')
            .attr('x', d => d.children ? -13 : 13)
            .style('text-anchor', d => d.children ? 'end' : 'start')
            .text(d => d.data.name);
        
        // Draw spouse nodes
        const spouseNodes = g.selectAll('.spouse-node')
            .data(treeLayout.descendants().filter(d => d.data.spouse))
            .enter()
            .append('g')
            .attr('class', d => `tree-node spouse ${d.data.spouse.gender}`)
            .attr('transform', d => `translate(${d.y + 50},${d.x})`)
            .on('click', (event, d) => {
                selectPerson(d.data.spouse.id);
            });
        
        spouseNodes.append('circle')
            .attr('r', 6);
        
        spouseNodes.append('text')
            .attr('dy', '.35em')
            .attr('x', 13)
            .style('text-anchor', 'start')
            .text(d => d.data.spouse.name);
        
        // Center the tree
        centerTree();
    }

    function centerTree() {
        if (!svg || !g) return;
        
        const bounds = g.node().getBBox();
        const parent = svg.node().getBoundingClientRect();
        const fullWidth = parent.width;
        const fullHeight = parent.height;
        const width = bounds.width;
        const height = bounds.height;
        const midX = bounds.x + width / 2;
        const midY = bounds.y + height / 2;
        
        const scale = 0.8 / Math.max(width / fullWidth, height / fullHeight);
        const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];
        
        svg.transition()
            .duration(750)
            .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
    }

    function expandAll() {
        // Implementation for expanding all nodes
        if (currentPersonId) {
            updateD3Tree(familyData[currentPersonId], currentPersonId);
        }
    }

    function collapseAll() {
        // Implementation for collapsing nodes
        if (currentPersonId) {
            treeData = buildTreeData(currentPersonId, 1);
            updateD3Tree(familyData[currentPersonId], currentPersonId);
        }
    }
</script>
{% endblock %}
